# Forced OAuth profile linking
* This lab fives you the option to attach a social media profile to your account so that you can log in via OAuth instead of using the normal username and password. Due to the insecure implementation of the OAuth flow by the client applciation, an attacker can manipulate this functionality to obtain access to other users' accounts.
* To sovle the lab, use a CSRF attack to attach your own social media profile to the admin user's account on the blog website, then access the admin panel and delete Carlos.
* The admin user will open anything you send from the exploit server and they always have an active session on the blog website.
* You can log in to your own account using the following credentials:
	* Blog website account: `wiener: peter`
	* Social media profile: `peter.wiener:hotdog`

### 1. Enumerate the web page
* Try to login with the classic username and passwords.

![6](https://user-images.githubusercontent.com/53956303/156686784-80017b06-7107-4ef0-9c6d-5a59610afced.png)
* Try to use "Attach a social profile" with provided credential for enumeration

![7](https://user-images.githubusercontent.com/53956303/156686912-ac07759f-edae-496e-94ea-415f41b310b5.png)
* When click the sign in, the authorization panel is given.

![8](https://user-images.githubusercontent.com/53956303/156686999-bb12e670-08a2-4709-a2ed-f7b8f823e469.png)
* When confirm the authorization, a request `GET /auth` request is found from the Burp.

![9](https://user-images.githubusercontent.com/53956303/156687163-9460a4a9-1747-4da9-9196-d3f33dc83a2f.png)
* from the reqeust, `redirect_uri` is to `/oauth-linking`. Also, the reqeust does not include a `state` parameter to protect against CSRF attacks.

### 2. Intercept a new `/oauth-linking` request
* Intercept the request and forward until the `/oauth-linking` request is given.
	* The request includes a `Code=109cQTn9FqJSfh_4oq689Rvw9aiK3LowOcdnW2B7KfW` parameter.

![10](https://user-images.githubusercontent.com/53956303/156687599-432a13c8-6020-428c-b388-cbb87891f0a7.png)
* Right click to copy the URL, and drop the request.
```http
https://ac141f271ed5889cc03b3ee000590034.web-security-academy.net/oauth-linking?code=109cQTn9FqJSfh_4oq689Rvw9aiK3LowOcdnW2B7KfW
```
* Then, turn off the proxy intercepttor and log out of the blog website.
### 3. Create a malicious Iframe using the provided exploit server
```iframe
<iframe src="https://ac141f271ed5889cc03b3ee000590034.web-security-academy.net/oauth-linking?code=109cQTn9FqJSfh_4oq689Rvw9aiK3LowOcdnW2B7KfW"></iframe>
```
* Store and deliver the exploit. When their browser loads the `iframe`, it will complete the OAuth flow using the `peter.wiener` account, attaching it to the admin account on the blog website.

![11](https://user-images.githubusercontent.com/53956303/156688112-82df7679-82d5-4a91-98ff-e03b917cd29f.png)
* Then, Use the "Log in with social media" option to log in with `peter.wiener` account.
	* As a result, the `peter.wiener` account is directly log in as the admin, and the access to the admin panel is granted.

![12](https://user-images.githubusercontent.com/53956303/156688301-4984810a-f100-42a5-8e84-f543f574215e.png)
* When delete the Carlos account on the admin panel, the lab is solved.

![13](https://user-images.githubusercontent.com/53956303/156688398-400cfe0e-001c-4ad0-913f-2197408149f3.png)
