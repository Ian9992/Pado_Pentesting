# Exploiting DOM clobbering to enable XSS
* This lab contains a DOM-cloberring vulnerability. The comment functionality allows "safe" HTML. To solve the lab, construct an HTML injection that clobbers a variable and uses XSS to call the `alert()` function

### 1. Use a browser's inspector to enumerate JavaScript file
* From a one of a product page, a JavaScript file `loadCommentsWithDomClobbering.js`, a variable "defaultAvatar" is found

![15](https://user-images.githubusercontent.com/53956303/154568578-cb5fb0d9-06ec-4ca0-bc66-eea16bbe2c4c.png)
### 2. Create a comment containing clobbering anchors
* Since the HTML is allowed in the comment, use this script
```html
<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">
```
### 3. Return to the blog post and create a second comment containing any random text
* the next time the page loads, the `alert()` is called
```html
let defaultAvatar = window.defaultAvatar || {avatar: '/resource/images/avatarDefault.svg'}
```
![16](https://user-images.githubusercontent.com/53956303/154570251-a2b40dfb-4929-4595-a848-b6061d44c7a9.png)
* the `defaultAvatar` object is implemented using this dangerous pattern containing the logical `OR` operator in conjnction with a global variable. This makes it vulnerable to DOM clobbering.
* You can clobber this object using anchor tags. Creating two anchors with the same ID causes them to be grouped in a DOM collection. The `name` attribute in the second anchor contains the value "avatar", which will clobber the `avatar` property with the contents of the `href` attribute.

![19](https://user-images.githubusercontent.com/53956303/154570713-d743753d-cf7f-44d3-b458-3ed0410fefdb.png)
* Notice that the site uses the DOMPurify filter in an attempt to reduce DOM-based vulnerabilities. However, DOMPurify allows you to use the `cid:` protocol, which does not URL-encoded double-quotes, this means you can inject an encoded double-quote that will be decoded at runtime. As a result, the injection described above will cause the `defaultAvatart` variable to be assigned the clobbered property `{avatar: 'cid:"onerror=alert(1)//'}` the next time the page is loaded.
  * When you make a second post, the browser uses the newly-clobbered global variable, whcih suggles the payload in the `onerror` event handler and triggers the `alert()`

![17](https://user-images.githubusercontent.com/53956303/154570357-cf15bcde-f97b-4337-9c63-8c3bc9bb7dc8.png)
* As a result, the lab is solved.

![18](https://user-images.githubusercontent.com/53956303/154570429-af113272-2e3b-4b3e-8e6b-b6ea75650e0b.png)
