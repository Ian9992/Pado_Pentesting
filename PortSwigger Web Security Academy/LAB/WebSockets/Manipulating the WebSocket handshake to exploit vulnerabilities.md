# Manipulating the WebSocket handshake to exploit vulnerabilities
* This online shop has a live chat feature implemented using WebSockets. It has an aggressive but flawed XSS filter.
	* To solve the lab, use a WebSocket message to trigger an `alert()` popup in the support agent's browser.
	
### 1. Capture the traffic when using the live chat
* From the WebSpclet history, send a request that contains a WebSocket message to server.

![5](https://user-images.githubusercontent.com/53956303/157319961-ca264812-d631-42b8-8e04-a8b09452b77b.png)
### 2. Try to send a XSS payload
* To trigger an alert on the support agent's browser.
```json
{"message":"<img src=1 onerror='alert(1)'>"}
```
* However, a XSS filter is blocked the attack. Also the WebSocket connection has been terminated.

![6](https://user-images.githubusercontent.com/53956303/157320280-05666675-bdb5-4e6d-a385-b585c3facca7.png)
### 3. Try again using _X-Forwarded-For_ header to bypass the IP ban
* When click the "Reconnect", the connection attempt fails becuase the attacker's IP address has been banned.
	* Thus, use `X-Forwarded-For` header to make a new handshake request to spoof the IP address
```http
X-Forwarded-For: 1.1.1.1
```
![7](https://user-images.githubusercontent.com/53956303/157321047-b2709ea3-747f-4c1d-b618-bd555a91ec90.png)
* As a result, successfully reconnected.

![8](https://user-images.githubusercontent.com/53956303/157321144-559cfc21-92d5-456b-82bc-1ff1782304f5.png)
### 4. Use some uppercases and lowercases to obfuscate the server
```json
{"message":"<img src=1 OneRrOr=alert`1`>"}
```
* As a result, an alert is triggered on the support agent's browser and the lab is solved.

![9](https://user-images.githubusercontent.com/53956303/157321718-e17e0f06-0b51-4745-80b8-fe8c498e3ce0.png)
