# Web cache poisoning to exploit a DOM vulnerability via a cache with stric cacheability criteria
* This lab ontains a DOM-based vulnerability that can be exploited as part of a web cache poisoning attack. A user visits the home page roughly once a minute. Note that the cache used by this lab has stricter criteria for deciding which responses are cacheable, so you will need to study the cache behavior closely.
	* To solve the lab, poison the cache with a response that executes `alert(document.cookie)` in the visitor's browser.
### 1. Identify some headers to use for the exploit
* Using Param Miner to identify the headers to use for the exploit.

![28](https://user-images.githubusercontent.com/53956303/155821638-1d054dc6-8ada-4318-b9f1-ad7a834830c8.png)
* From the result, an interesting header `X-Forwarded-host` is found
### 2. Add a cache-buster query parameter and header at a request
* use `cb=12345` as the cache-buset query parameter, and `X-Forwarded-Host: test.com` as the header.
	* the `data.host` is overwrited by the entered value.

![29](https://user-images.githubusercontent.com/53956303/155821828-c3750e5c-f47e-4f00-9f6a-53d05533b137.png)
* From the bottom of the response, the `data.host` is used by `initGeoLocate()` function, which is in `/resources/json/geolocate.js`

![30](https://user-images.githubusercontent.com/53956303/155821929-32154728-d5cf-4508-91eb-d8015702e26f.png)
### 3. Enumerate the `geolocate.js`
![image](https://user-images.githubusercontent.com/53956303/155822161-b24438ca-e730-4014-afed-1f1d1ea6c5fa.png)
* It looks very vulnerable to DOM-based XSS according to [Port Swigger DOM-based XSS](https://portswigger.net/web-security/cross-site-scripting/dom-based).
	* It uses similar pattern as a vulnerable sink `document.write()`

### 4. Create a vulnerable `geolocate.json` using the provided exploit server
* Make a vulnerable JSON file that has a XSS payload at the body, and add `Access-Control-Allow-Origin: *` header to allow CORS at the Head of the exploit.
```json
{
"country":"<img src=1 onerror=alert(document.cookie) />"
}
```
![33](https://user-images.githubusercontent.com/53956303/155822734-d4978b62-91e0-4c9c-b14b-27b3c79add62.png)
### 5. Send the modified request
* change the address of `X-Forwarded-Host` to the exploit lab. Lastly, remove the cache-buster query parameter.
	* Then, send the request until the `X-Cache: hit` is given on the response.

![34](https://user-images.githubusercontent.com/53956303/155822858-60600088-a011-4a76-b5a3-fb8abd9265ff.png)
* Keep sending the request until the victim visits the home page.
	* As a result, the lab is solved.

![35](https://user-images.githubusercontent.com/53956303/155822933-fcdc4d07-5832-4aba-aef5-736b8ff37e53.png)
